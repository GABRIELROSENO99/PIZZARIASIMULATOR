<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria Helber B - Australian Man</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'aussie-orange': '#D96E01',
                        'aussie-green': '#00843D',
                        'bancada-brown': '#6D4C41',
                        'fundo-claro': '#FFF5E6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS para o tema Aussie */
        body {
            background-color: #f0f0f0;
            font-family: 'Inter', sans-serif;
        }

        /* Anima√ß√£o do fundo Aussie/R√∫stico */
        .aussie-background {
            background-image: url('https://placehold.co/1920x1080/D96E01/FFFFFF?text=FUNDO+R%C3%9ASTICO+PIZZARIA+AUSTRALIANA');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            z-index: 1;
        }

        .aussie-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            /* Camada de opacidade para a UI */
            z-index: 2;
        }

        #game-ui {
            z-index: 3;
            position: relative;
        }

        /* Estilo da Bancada da Pizza */
        #pizza-bench {
            background-color: #bcaaa4;
            /* M√°rmore claro/madeira */
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Estilo do Helber (Texto/Emoji) */
        #helber-avatar {
            font-size: 3rem;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }

        /* Bot√£o de Ingrediente */
        .ingredient-btn {
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
        }
        .ingredient-btn:active {
            transform: scale(0.95);
            box-shadow: none;
        }

        /* Pizza Stack - Visual Feedback */
        #pizza-stack {
            min-height: 200px;
            display: flex;
            flex-direction: column-reverse;
            /* Empilha de baixo para cima */
            align-items: center;
            justify-content: center;
        }
        .pizza-layer {
            width: 90%;
            height: 20px;
            border-radius: 50%;
            margin-top: -10px;
            /* Sobrep√µe as camadas */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease-out;
        }
        .layer-molho {
            background-color: #c0392b;
        }
        .layer-queijo {
            background-color: #f1c40f;
        }
        .layer-carne {
            background-color: #8B4513;
        }
        .layer-vegetal {
            background-color: #27ae60;
        }
        .layer-premium {
            background-color: #9b59b6;
        }
        .layer-abacaxi {
            background-color: #f39c12;
        }


        /* Foguetes de Artif√≠cio (Vit√≥ria) */
        .firework {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            opacity: 0;
            animation: firework-burst 0.8s ease-out forwards;
        }

        @keyframes firework-burst {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) scale(0.5);
            }
        }

        /* Timer Bar */
        #timer-bar-fill {
            /* Transi√ß√£o ajustada para dar a sensa√ß√£o de crescimento/ac√∫mulo */
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="aussie-background min-h-screen p-4 md:p-8">

    <audio id="background-music" src="The Most Popular Italian Pizza Music! Italian Tarantella Background Music For Food Videos .mp3" loop></audio>

    <div id="game-ui" class="max-w-7xl mx-auto">
        <header class="bg-white/90 p-4 mb-6 rounded-xl shadow-lg border-t-4 border-aussie-green">
            <div class="flex flex-col md:flex-row justify-between items-center text-center">
                <h1 class="text-3xl font-black text-aussie-orange uppercase tracking-wider mb-2 md:mb-0">
                    Pizzaria Helber B - Australian Man
                </h1>

                <div class="flex space-x-4 font-bold text-lg">
                    <span id="fase-counter" class="bg-aussie-green text-white px-3 py-1 rounded-full shadow-md">Fase: 1/5</span>
                    <span id="pizza-counter" class="bg-aussie-orange text-white px-3 py-1 rounded-full shadow-md">Pizzas: 0/25</span>
                    <span id="saldo-counter" class="bg-gray-700 text-white px-3 py-1 rounded-full shadow-md">Saldo: R$ 0</span>
                    <span id="highscore-display" class="bg-blue-600 text-white px-3 py-1 rounded-full shadow-md">Recorde: R$ 0</span>
                </div>
            </div>
            <div id="game-message" class="mt-3 text-center text-xl font-semibold text-gray-800">
                Helber: "G'day, mate! Let's make some wicked pizzas today!"
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <div class="lg:col-span-3 space-y-6">
                <div id="ingredients-shelf" class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-green">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">Ingredientes </h2>
                    <div id="ingredient-buttons" class="grid grid-cols-3 gap-2">
                    </div>
                </div>

                <div class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-orange max-h-96 overflow-y-auto">
                    <h2 class="text-xl font-bold mb-3 text-aussie-green">Receitas (Ordem Exata!) </h2>
                    <div id="recipe-list" class="text-sm font-mono text-gray-700 space-y-2">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6 flex flex-col items-center space-y-4">
                <div class="text-center">
                    <span id="helber-avatar"> </span>
                    <p class="text-xl font-bold text-gray-800">Helber B.</p>
                </div>

                <div id="pizza-bench" class="w-full max-w-lg h-80 flex flex-col items-center justify-center p-4">
                    <h3 class="text-center text-lg font-semibold mb-4 text-white p-2 rounded-lg bg-gray-800/70">
                        Sua Pizza
                    </h3>
                    <div id="pizza-stack"
                        class="w-64 h-64 border-8 border-dashed border-aussie-orange/50 rounded-full bg-aussie-orange/10 flex flex-col items-center justify-center">
                        <p id="current-pizza-base" class="text-sm text-gray-600">Massa (Clique no primeiro ingrediente)</p>
                    </div>
                </div>

                <button id="deliver-btn" disabled
                    class="w-full max-w-sm bg-gray-400 text-white font-black text-xl py-3 rounded-full shadow-lg transition duration-150 hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    ENTREGAR AO CLIENTE
                </button>

                <div class="w-full max-w-lg mt-4 bg-gray-200 rounded-full h-4">
                    <div id="timer-bar-fill" class="bg-green-500 h-4 rounded-full" style="width: 0%;"></div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div id="order-queue" class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-green">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">Pr√≥ximo Pedido </h2>
                    <p id="customer-wait-timer" class="text-md font-bold text-green-600 mb-2">
                        CLIENTE AGUARDANDO A (00:00)
                    </p>
                    <div id="current-order-card"
                        class="bg-yellow-100 p-3 rounded-lg shadow-md border-l-4 border-yellow-500">
                        <p class="text-sm text-gray-500">Cliente (Aguardando Helber)</p>
                        <p id="customer-avatar" class="text-2xl mt-1"></p>
                        <p id="current-order-name" class="text-xl font-black text-red-700 mt-2">...</p>
                    </div>
                </div>

                <div id="feedback-area"
                    class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-orange min-h-[100px]">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">Feedback </h2>
                    <p id="feedback-text" class="text-lg italic text-gray-600">Aguardando entrega...</p>
                </div>
            </div>
        </main>

        <div id="game-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div id="modal-content"
                class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center border-t-8 border-aussie-orange">
                <h2 id="modal-title" class="text-3xl font-black mb-4 text-aussie-green">Bem-vindo, Mate!</h2>
                <p id="modal-body" class="mb-6 text-gray-700">Pressione Iniciar para come√ßar sua jornada como o Pizzaiolo
                    Helber B!</p>
                <div id="modal-actions">
                    <button id="start-game-btn"
                        class="bg-aussie-orange text-white font-bold py-3 px-6 rounded-full text-lg transition duration-150 hover:bg-aussie-green">
                        Iniciar Dia 1
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais de ambiente (PREENCHIDAS PELO CANVAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // Configura√ß√µes e Vari√°veis Globais do Jogo
        let GAME_STATE = {
            currentPhase: 1,
            pizzasCompleted: 0,
            balance: 0,
            highScore: 0,
            streak: 0,
            isGameRunning: false,
            currentOrder: null,
            appliedIngredients: [],
            phaseGoal: 25,
            timerMax: 0,
            elapsedTime: 0, // ALTERADO: Contar√° o tempo que passou.
            isAuthReady: false,
            userId: null,
        };
        // --- ALTERA√á√ÉO 2: INCLUS√ÉO DOS EMOJIS SOLICITADOS ---
        const INGREDIENTS = {
            'MOLHO': { color: '#c0392b', emoji: 'ü•´', type: 'layer-molho' },
            'QUEIJO': { color: '#f1c40f', emoji: 'üßÄ', type: 'layer-queijo' },
            'CALABRESA': { color: '#e74c3c', emoji: '', type: 'layer-carne' },
            'PEPPERONI': { color: '#c0392b', emoji: '', type: 'layer-carne' },
            'FRANGO': { color: '#f39c12', emoji: '', type: 'layer-carne' },
            'CATUPIRY': { color: '#ecf0f1', emoji: '', type: 'layer-queijo' },
            'MANJERIC√ÉO': { color: '#2ecc71', emoji: 'üåø', type: 'layer-vegetal' },
            'OR√âGANO': { color: '#27ae60', emoji: '', type: 'layer-vegetal' },
            'CEBOLA': { color: '#bdc3c7', emoji: '', type: 'layer-vegetal' },
            'COGUMELOS': { color: '#95a5a6', emoji: '', type: 'layer-vegetal' },
            'GORGONZOLA': { color: '#3498db', emoji: '', type: 'layer-queijo' },
            'PROVOLONE': { color: '#9b59b6', emoji: '', type: 'layer-queijo' },
            'BACON': { color: '#e67e22', emoji: '', type: 'layer-carne' },
            'AZEITONAS': { color: '#2c3e50', emoji: '', type: 'layer-vegetal' },
            'PIMENT√ÉO': { color: '#e67e22', emoji: '', type: 'layer-vegetal' },
            'ABACAXI': { color: '#f1c40f', emoji: '', type: 'layer-abacaxi' },
            'PRESUNTO': { color: '#e67e22', emoji: '', type: 'layer-carne' },
            'PARMES√ÉO': { color: '#f39c12', emoji: '', type: 'layer-queijo' },
            'BR√ìCOLIS': { color: '#2ecc71', emoji: '', type: 'layer-vegetal' },
            'QUEIJO EXTRA': { color: '#f1c40f', emoji: '', type: 'layer-queijo' },
            'CARNE MO√çDA': { color: '#8B4513', emoji: '', type: 'layer-carne' },
            'ATUM': { color: '#2c3e50', emoji: '', type: 'layer-carne' },
            'ESCARGOT': { color: '#9b59b6', emoji: '', type: 'layer-premium' },
        };
        // --------------------------------------------------
        
        const RECIPES = {
            'MARGHERITA': { ingredients: ['MOLHO', 'QUEIJO', 'MANJERIC√ÉO'], price: 50, phaseMin: 1 },
            'CALABRESA': { ingredients: ['MOLHO', 'QUEIJO', 'CALABRESA', 'CEBOLA'], price: 60, phaseMin: 1 },
            'FRANGO CATUPIRY': { ingredients: ['MOLHO', 'QUEIJO', 'FRANGO', 'CATUPIRY'], price: 70, phaseMin: 1 },
            'PEPPERONI': { ingredients: ['MOLHO', 'QUEIJO', 'PEPPERONI', 'OR√âGANO'], price: 75, phaseMin: 1 },
            'BACON': { ingredients: ['MOLHO', 'QUEIJO', 'BACON', 'CEBOLA'], price: 70, phaseMin: 1 },
            'QUATRO QUEIJOS': { ingredients: ['MOLHO', 'QUEIJO', 'GORGONZOLA', 'PROVOLONE', 'PARMES√ÉO'], price: 90, phaseMin: 2 },
            'COGUMELOS': { ingredients: ['MOLHO', 'QUEIJO', 'COGUMELOS', 'MANJERIC√ÉO'], price: 65, phaseMin: 2 },
            'HAWAIIAN': { ingredients: ['MOLHO', 'QUEIJO', 'PRESUNTO', 'ABACAXI'], price: 80, phaseMin: 2 },
            'AZEITONA': { ingredients: ['MOLHO', 'QUEIJO', 'AZEITONAS', 'PIMENT√ÉO'], price: 60, phaseMin: 3 },
            'BR√ìCOLIS': { ingredients: ['MOLHO', 'QUEIJO', 'BR√ìCOLIS', 'QUEIJO EXTRA'], price: 85, phaseMin: 3 },
            'CARNE': { ingredients: ['MOLHO', 'QUEIJO', 'CARNE MO√çDA', 'CEBOLA'], price: 70, phaseMin: 4 },
            'ATUM': { ingredients: ['MOLHO', 'QUEIJO', 'ATUM', 'OR√âGANO'], price: 65, phaseMin: 4 },
            'ESCARGOT': { ingredients: ['MOLHO', 'QUEIJO', 'ESCARGOT', 'MANJERIC√ÉO'], price: 120, phaseMin: 5 }, // Premium
            'VEGETARIANA': { ingredients: ['MOLHO', 'QUEIJO', 'PIMENT√ÉO', 'COGUMELOS', 'ABACAXI'], price: 95, phaseMin: 5 },
            'SUPREMA': { ingredients: ['MOLHO', 'QUEIJO', 'PEPPERONI', 'BACON', 'COGUMELOS', 'PIMENT√ÉO'], price: 110, phaseMin: 5 },
        };
        const PHASES = {
            1: { goal: 2, timer: 0, available: ['MARGHERITA', 'CALABRESA', 'FRANGO CATUPIRY', 'PEPPERONI', 'BACON'], message: "Dia de treino! Sem press√£o, mate!" }, // Reduzido goal para teste
            2: { goal: 5, timer: 120, available: 8, message: "Aperta o passo! O rel√≥gio est√° correndo, cobber!" }, // Reduzido goal para teste
            3: { goal: 5, timer: 105, available: 12, message: "A clientela est√° agitada, menos tempo para errar!" },
            4: { goal: 5, timer: 90, available: 15, message: "Dia de super-pico! Pedidos piscando!" },
            5: { goal: 5, timer: 75, available: 15, message: "Final do campeonato! Acerto triplo √© dinheiro extra!" },
        };

        // Frases de elogio expandidas com o tema Brasil/S√£o Paulo
        const PRAISE_PHRASES = [
            "Deliciosa mate!", "Perfeita, cobber!", "A melhor da Austr√°lia!", "Queijo derretido top!",
            "Simplesmente perfeito!", "Dez de dez!", "Eu voltarei!", "Fant√°stico!", "Sabor impec√°vel, mate!",
            "Muito bom, amigo!", "Que fatia de pizza!", "Obrigado, lenda!",
            "Entrega incrivelmente r√°pida! Voc√™ √© um foguete, Helber!",
            "Helber √© o mestre da velocidade! Ripper!",
            "Essa rapidez √© nota 10! N√£o deu tempo nem de piscar!",
            "√â sabor de S√£o Paulo, Helber! Que saudade da pizza brasileira!",
            "Esse queijo lembra o da Mooca! Sabor de casa!",
            "Atendimento Aussie, sabor brasileiro. Combina√ß√£o perfeita!",
        ];
        const HELBER_SPEAK = {
            START: "G'day, mate! Let's make some wicked pizzas today!",
            CORRECT: "Fair dinkum! Nailed it, mate! Get that dough!",
            WRONG: "Crikey! That's gone belly up. Try again, cobber!",
            NEXT_PHASE: "Ripper! We smashed that day. Now for the next one!",
            VICTORY: "You beaut! We did it! Pizza empire, here we come!",
        };
        let timerInterval = null;
        let comboStreak = 0;

        // --- DOM Elements ---
        const elements = {
            faseCounter: document.getElementById('fase-counter'),
            pizzaCounter: document.getElementById('pizza-counter'),
            saldoCounter: document.getElementById('saldo-counter'),
            highscoreDisplay: document.getElementById('highscore-display'),
            gameMessage: document.getElementById('game-message'),
            ingredientButtons: document.getElementById('ingredient-buttons'),
            recipeList: document.getElementById('recipe-list'),
            pizzaStack: document.getElementById('pizza-stack'),
            deliverBtn: document.getElementById('deliver-btn'),
            currentOrderName: document.getElementById('current-order-name'),
            customerAvatar: document.getElementById('customer-avatar'),
            feedbackText: document.getElementById('feedback-text'),
            timerBarFill: document.getElementById('timer-bar-fill'),
            gameModal: document.getElementById('game-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalActions: document.getElementById('modal-actions'),
            startGameBtn: document.getElementById('start-game-btn'),
            currentPizzaBase: document.getElementById('current-pizza-base'),
            customerWaitTimer: document.getElementById('customer-wait-timer'),
            // ADICIONADO: Elemento de m√∫sica
            backgroundMusic: document.getElementById('background-music'),
        };
        // --- Firebase Setup (Mantido como estava) ---
        let db, auth;
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not available. Running game without persistence.");
                GAME_STATE.isAuthReady = true;
                elements.highscoreDisplay.textContent = "Recorde: R$ 0 (Local)";
                return;
            }

            try {
                // ... (L√≥gica de inicializa√ß√£o Firebase omitida para brevidade, mas mantida no c√≥digo original)
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Log level for Firestore

                let userCredential;
                try {
                    if (initialAuthToken) {
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        userCredential = await signInAnonymously(auth);
                    }
                } catch (error) {
                    userCredential = await signInAnonymously(auth);
                }

                GAME_STATE.userId = userCredential.user.uid;
                GAME_STATE.isAuthReady = true;
                loadGameState();
            } catch (error) {
                console.error("Erro fatal ao inicializar Firebase ou Autenticar:", error);
                GAME_STATE.isAuthReady = true;
                elements.highscoreDisplay.textContent = "Recorde: R$ 0 (Erro Auth)";
            }
        }

        function getUserScoreDocRef() {
            if (!db || !GAME_STATE.userId) return null;
            const collectionPath = `/artifacts/${appId}/users/${GAME_STATE.userId}/pizzagame_scores`;
            return doc(db, collectionPath, 'high_score');
        }

        function loadGameState() {
            if (!GAME_STATE.isAuthReady || !db || !GAME_STATE.userId) return;
            const docRef = getUserScoreDocRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    GAME_STATE.highScore = data.highScore || 0;
                } else {
                    saveGameState();
                }
                updateUI();
            }, (error) => {
                console.error("Erro ao ouvir High Score:", error);
            });
        }

        async function saveGameState() {
            if (!GAME_STATE.isAuthReady || !db || !GAME_STATE.userId) return;
            try {
                const docRef = getUserScoreDocRef();
                if (!docRef) return;
                await setDoc(docRef, {
                    highScore: GAME_STATE.highScore,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
            } catch (e) {
                console.error("Erro ao salvar High Score:", e);
            }
        }
        // --- Web Speech Synthesis (Helber's Voice) (Mantido como estava) ---
        function helberSpeak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                const voices = window.speechSynthesis.getVoices();
                let aussieVoice = voices.find(voice => voice.lang === 'en-AU');
                if (aussieVoice) {
                    utterance.voice = aussieVoice;
                } else {
                    utterance.voice = voices[0] || null;
                }
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("Speech Synthesis n√£o suportado neste navegador.");
            }
        }
        // --- Game Logic ---
        function startGame() {
            GAME_STATE.currentPhase = 1;
            GAME_STATE.balance = 0;
            GAME_STATE.streak = 0;
            GAME_STATE.isGameRunning = true;
            hideModal();
            startPhase();
            helberSpeak(HELBER_SPEAK.START);

            // ADI√á√ÉO: Tocar a m√∫sica quando o jogo iniciar ap√≥s a intera√ß√£o do usu√°rio.
            if (elements.backgroundMusic) {
                elements.backgroundMusic.volume = 0.3; // Define um volume baixo para a m√∫sica de fundo
                // Play() deve ser chamado ap√≥s uma intera√ß√£o do usu√°rio para funcionar na maioria dos navegadores
                elements.backgroundMusic.play().catch(e => console.log("M√∫sica n√£o p√¥de ser iniciada (Autoplay bloqueado):", e));
            }
        }
        function startPhase() {
            const phase = PHASES[GAME_STATE.currentPhase];
            GAME_STATE.pizzasCompleted = 0;
            GAME_STATE.phaseGoal = phase.goal;
            GAME_STATE.timerMax = phase.timer * 1000;
            GAME_STATE.elapsedTime = 0; // Reset do tempo
            GAME_STATE.appliedIngredients = [];
            resetPizzaBench();
            updateUI();
            displayMessage(phase.message);
            if (GAME_STATE.currentPhase === 1) {
                generateNextOrder();
            } else {
                GAME_STATE.currentOrder = null;
            }
        }
        /**
         * Retorna a lista de nomes de ingredientes que est√£o em *qualquer* receita
         * dispon√≠vel para a fase atual.
         */
        function getAvailableIngredientsForPhase() {
            const availableRecipes = Object.keys(RECIPES).filter(name => RECIPES[name].phaseMin <= GAME_STATE.currentPhase);
            const uniqueIngredients = new Set();
            availableRecipes.forEach(rName => {
                RECIPES[rName].ingredients.forEach(iName => {
                    uniqueIngredients.add(iName);
                });
            }); // Na Fase 1, se tivermos uma lista restrita de receitas, usamos elas.
            if (GAME_STATE.currentPhase === 1 && PHASES[1].available.length > 0) {
                return PHASES[1].available.flatMap(rName => RECIPES[rName].ingredients).filter((v, i, a) => a.indexOf(v) === i);
            }
            return Array.from(uniqueIngredients);
        }

        function generateNextOrder() {
            const availableRecipes = Object.keys(RECIPES).filter(name => RECIPES[name].phaseMin <= GAME_STATE.currentPhase);
            if (availableRecipes.length === 0) {
                console.error("Nenhuma receita dispon√≠vel para a fase atual.");
                return;
            }
            // Na fase 1, restringe-se ainda mais aos itens dispon√≠veis:
            const finalRecipes = GAME_STATE.currentPhase === 1 ? PHASES[1].available : availableRecipes;
            
            // Seleciona uma receita aleatoriamente
            const randomRecipeName = finalRecipes[Math.floor(Math.random() * finalRecipes.length)];
            const order = RECIPES[randomRecipeName];

            GAME_STATE.currentOrder = {
                name: randomRecipeName,
                recipe: order.ingredients,
                price: order.price,
            };
            elements.currentOrderName.textContent = GAME_STATE.currentOrder.name;
            elements.customerAvatar.textContent = getRandomCustomerEmoji();
            // O timer s√≥ come√ßa a contar quando o pedido √© gerado
            resetTimer(GAME_STATE.timerMax);
            updateUI();
        }

        function addIngredient(ingredientName) {
            if (!GAME_STATE.isGameRunning || !GAME_STATE.currentOrder) return;
            GAME_STATE.appliedIngredients.push(ingredientName);
            renderPizzaStack();
            updateUI();
        }

        function deliverPizza() {
            if (GAME_STATE.appliedIngredients.length === 0 || !GAME_STATE.currentOrder) return;
            stopTimer();

            const correctRecipe = GAME_STATE.currentOrder.recipe;
            const applied = GAME_STATE.appliedIngredients;

            // 1. Verifica o tamanho
            if (applied.length !== correctRecipe.length) {
                handleWrongOrder("Falta ou sobra de ingredientes, Helber!");
                return;
            }
            // 2. Verifica a ordem exata
            let isCorrect = true;
            for (let i = 0; i < correctRecipe.length; i++) {
                if (applied[i] !== correctRecipe[i]) {
                    isCorrect = false;
                    break;
                }
            }

            if (isCorrect) {
                handleCorrectOrder();
            } else {
                handleWrongOrder("A ordem dos ingredientes est√° errada, cobber!");
            }
        }

        function handleCorrectOrder() {
            let price = GAME_STATE.currentOrder.price;
            comboStreak++;

            if (comboStreak >= 5) {
                price = Math.round(price * 1.5);
                elements.feedbackText.textContent = ` STREAK x1.5! Pizza perfeita! +R$${price}`;
                displayMessage(HELBER_SPEAK.CORRECT, 'text-green-700 font-extrabold');
            } else {
                const praise = getRandomPraisePhrase();
                elements.feedbackText.textContent = praise;
                displayMessage(HELBER_SPEAK.CORRECT, 'text-green-600');
            }

            if (GAME_STATE.currentPhase === 5 && comboStreak > 0 && comboStreak % 3 === 0) {
                price *= 2;
                elements.feedbackText.textContent = ` COMBO ESPECIAL X2! +R$${price} | ${elements.feedbackText.textContent}`;
            }

            GAME_STATE.balance += price;
            GAME_STATE.pizzasCompleted++;
            helberSpeak(HELBER_SPEAK.CORRECT);
            animatePizzaDelivery();

            setTimeout(() => {
                continueGameFlow();
            }, 1500);
        }

        function handleWrongOrder(reason) {
            GAME_STATE.balance = Math.max(0, GAME_STATE.balance - 20);
            comboStreak = 0;
            elements.feedbackText.textContent = ` Penalidade (-R$20). ${reason}`;
            displayMessage(` Crikey! That's gone belly up. Try again, cobber!`, 'text-red-600');
            helberSpeak(HELBER_SPEAK.WRONG);
            animatePizzaExplosion();

            setTimeout(() => {
                continueGameFlow();
            }, 1500);
        }

        function continueGameFlow() {
            if (GAME_STATE.pizzasCompleted >= GAME_STATE.phaseGoal) {
                // Fim da Fase
                if (GAME_STATE.balance > GAME_STATE.highScore) {
                    GAME_STATE.highScore = GAME_STATE.balance;
                    saveGameState();
                }
                
                if (GAME_STATE.currentPhase < 5) {
                    GAME_STATE.currentPhase++;
                    displayMessage(HELBER_SPEAK.NEXT_PHASE, 'text-blue-700 font-extrabold');
                    showModal(`Dia ${GAME_STATE.currentPhase - 1} Completo!`, `Voc√™ completou ${GAME_STATE.phaseGoal} pizzas! Saldo: R$ ${GAME_STATE.balance}. Prepare-se para o Dia ${GAME_STATE.currentPhase}!`, 'nextPhase');
                    startPhase(); // Come√ßa a pr√≥xima fase
                } else {
                    // Vit√≥ria Final
                    displayMessage(HELBER_SPEAK.VICTORY, 'text-purple-700 font-extrabold');
                    animateFireworks();
                    showModal("Vit√≥ria!", `Voc√™ √© o mestre pizzaiolo Helber B! Saldo Final: R$ ${GAME_STATE.balance}`, 'victory');
                    // Para a m√∫sica ao vencer
                    if (elements.backgroundMusic) elements.backgroundMusic.pause();
                }
            } else {
                // Continua o jogo
                resetPizzaBench();
                generateNextOrder();
            }
        }

        function gameOver() {
            GAME_STATE.isGameRunning = false;
            stopTimer();
            if (GAME_STATE.balance > GAME_STATE.highScore) {
                GAME_STATE.highScore = GAME_STATE.balance;
                saveGameState();
            }
            if (elements.backgroundMusic) elements.backgroundMusic.pause(); // Para a m√∫sica ao perder
            showModal("Game Over", `Voc√™ n√£o aguentou a press√£o! Saldo Final: R$ ${GAME_STATE.balance}`, 'gameOver');
            helberSpeak("Ah, well, that's disappointing mate. Have another go!");
        }

        function resetPizzaBench() {
            GAME_STATE.appliedIngredients = [];
            elements.pizzaStack.innerHTML = '';
            // Restaura a mensagem da base
            elements.currentPizzaBase.style.display = 'block';
            elements.pizzaStack.classList.add('border-dashed', 'border-aussie-orange/50');
            elements.pizzaStack.classList.remove('border-aussie-orange', 'bg-yellow-600');
        }
        // --- UI Rendering ---
        function updateUI() {
            elements.faseCounter.textContent = `Fase: ${GAME_STATE.currentPhase}/5`;
            elements.pizzaCounter.textContent = `Pizzas: ${GAME_STATE.pizzasCompleted}/${GAME_STATE.phaseGoal}`;
            elements.saldoCounter.textContent = `Saldo: R$ ${GAME_STATE.balance}`;
            elements.highscoreDisplay.textContent = `Recorde: R$ ${GAME_STATE.highScore}`;

            const canDeliver = GAME_STATE.isGameRunning && GAME_STATE.currentOrder && GAME_STATE.appliedIngredients.length > 0;
            elements.deliverBtn.disabled = !canDeliver;
            elements.deliverBtn.classList.remove('bg-aussie-orange', 'bg-gray-400');
            elements.deliverBtn.classList.add(canDeliver ? 'bg-aussie-orange' : 'bg-gray-400');
            elements.deliverBtn.classList.remove('hover:bg-aussie-green', 'hover:bg-gray-500');
            elements.deliverBtn.classList.add(canDeliver ? 'hover:bg-aussie-green' : 'hover:bg-gray-500');
            renderIngredientButtons();
            renderRecipeList();
            renderPizzaStack();
        }
        /**
         * Renderiza os bot√µes de ingredientes dispon√≠veis.
         * (Corrigido)
         */
        function renderIngredientButtons() {
            const container = elements.ingredientButtons;
            container.innerHTML = '';
            // Obt√©m apenas os nomes dos ingredientes necess√°rios nas receitas da fase atual
            const availableIngredients = getAvailableIngredientsForPhase();
            Object.keys(INGREDIENTS).forEach(name => {
                const ingredient = INGREDIENTS[name];
                // Verifica se o ingrediente est√° na lista de dispon√≠veis para a fase
                const isAvailable = availableIngredients.includes(name);
                const button = document.createElement('button');
                button.className = `ingredient-btn p-2 rounded-lg text-xs font-bold shadow-md flex flex-col items-center transition duration-100 ${isAvailable ? 'bg-fundo-claro border-2 border-aussie-green hover:bg-aussie-green/20' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`;
                button.disabled = !isAvailable;
                button.innerHTML = `<span class="text-xl">${ingredient.emoji}</span>${name}`;

                if (isAvailable) {
                    button.onclick = () => addIngredient(name);
                }
                container.appendChild(button);
            });
        }
        function renderRecipeList() {
            const container = elements.recipeList;
            container.innerHTML = '';
            const availableRecipes = Object.keys(RECIPES)
                .filter(name => RECIPES[name].phaseMin <= GAME_STATE.currentPhase)
                .sort((a, b) => RECIPES[a].phaseMin - RECIPES[b].phaseMin);

            availableRecipes.forEach(name => {
                const recipe = RECIPES[name];
                const item = document.createElement('div');
                item.className = 'bg-gray-50 p-2 rounded-md shadow-sm border border-gray-200';
                item.innerHTML = `
                    <p class="font-bold text-sm text-aussie-orange">${name} (R$${recipe.price})</p>
                    <p class="text-xs text-gray-600">${recipe.ingredients.join(' > ')}</p>
                `;
                container.appendChild(item);
            });
        }

        function renderPizzaStack() {
            const stack = elements.pizzaStack;
            // Limpa o stack
            stack.innerHTML = '';
            
            // Esconde a base de texto se houver ingredientes
            if (GAME_STATE.appliedIngredients.length > 0) {
                elements.currentPizzaBase.style.display = 'none';
                stack.classList.remove('border-dashed', 'border-aussie-orange/50', 'bg-aussie-orange/10');
                stack.classList.add('border-aussie-orange', 'bg-yellow-600');
            } else {
                elements.currentPizzaBase.style.display = 'block';
                stack.classList.add('border-dashed', 'border-aussie-orange/50', 'bg-aussie-orange/10');
                stack.classList.remove('border-aussie-orange', 'bg-yellow-600');
            }

            // Renderiza os ingredientes aplicados
            GAME_STATE.appliedIngredients.forEach(ingredientName => {
                const ingredient = INGREDIENTS[ingredientName];
                if (ingredient) {
                    const layer = document.createElement('div');
                    layer.className = `pizza-layer ${ingredient.type}`;
                    layer.style.backgroundColor = ingredient.color;
                    stack.appendChild(layer);
                }
            });
        }
        // --- Timer, Modal & FX ---
        function showModal(title, body, actionType) {
            elements.modalTitle.textContent = title;
            elements.modalBody.textContent = body;
            elements.modalActions.innerHTML = ''; // Limpa bot√µes antigos

            const button = document.createElement('button');
            button.className = "bg-aussie-orange text-white font-bold py-3 px-6 rounded-full text-lg transition duration-150 hover:bg-aussie-green";
            
            if (actionType === 'nextPhase') {
                button.textContent = `Iniciar Dia ${GAME_STATE.currentPhase}`;
                button.onclick = () => {
                    hideModal();
                    helberSpeak(HELBER_SPEAK.NEXT_PHASE);
                    // startPhase() j√° foi chamado em continueGameFlow
                };
            } else if (actionType === 'victory' || actionType === 'gameOver') {
                button.textContent = "Recome√ßar Dia 1";
                button.onclick = () => {
                    hideModal();
                    startGame();
                };
            } else {
                button.textContent = "Iniciar Dia 1";
                button.onclick = startGame;
            }
            elements.modalActions.appendChild(button);
            elements.gameModal.classList.remove('hidden');
        }

        function hideModal() {
            elements.gameModal.classList.add('hidden');
        }

        /**
         * Inicia o timer, contando de 0 at√© durationMs milissegundos (o limite).
         */
        function resetTimer(durationMs) {
            stopTimer();
            GAME_STATE.timerMax = durationMs;
            GAME_STATE.elapsedTime = 0;
            if (durationMs <= 0) {
                elements.timerBarFill.style.width = '0%';
                elements.customerWaitTimer.textContent = 'CLIENTE AGUARDANDO A (Sem Press√£o)';
                return;
            }

            const startTime = Date.now();
            const updateBar = () => {
                const now = Date.now();
                GAME_STATE.elapsedTime = now - startTime;
                
                const percentage = Math.min(100, (GAME_STATE.elapsedTime / GAME_STATE.timerMax) * 100);
                elements.timerBarFill.style.width = `${percentage}%`;

                // Cor da barra de progresso (verde -> amarelo -> vermelho)
                if (percentage < 50) {
                    elements.timerBarFill.style.backgroundColor = 'rgb(34, 197, 94)'; // green-500
                    elements.customerWaitTimer.classList.remove('text-red-600', 'text-yellow-600');
                    elements.customerWaitTimer.classList.add('text-green-600');
                } else if (percentage < 80) {
                    elements.timerBarFill.style.backgroundColor = 'rgb(234, 179, 8)'; // yellow-600
                    elements.customerWaitTimer.classList.remove('text-red-600', 'text-green-600');
                    elements.customerWaitTimer.classList.add('text-yellow-600');
                } else {
                    elements.timerBarFill.style.backgroundColor = 'rgb(239, 68, 68)'; // red-600
                    elements.customerWaitTimer.classList.remove('text-green-600', 'text-yellow-600');
                    elements.customerWaitTimer.classList.add('text-red-600');
                }
                
                // Atualiza o texto do tempo restante
                const timeLeft = Math.max(0, GAME_STATE.timerMax - GAME_STATE.elapsedTime);
                const seconds = Math.floor(timeLeft / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                elements.customerWaitTimer.textContent = `CLIENTE AGUARDANDO A (${timeString})`;

                if (GAME_STATE.elapsedTime >= GAME_STATE.timerMax) {
                    gameOver();
                }
            };

            timerInterval = setInterval(updateBar, 100);
            updateBar();
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (GAME_STATE.currentOrder) {
                elements.customerWaitTimer.textContent = `CLIENTE AGUARDANDO A (Limite Atingido)`;
                handleWrongOrder("Tempo esgotado, Helber!");
            }
        }
        // --- Utility Functions (Mantido como estava) ---
        function displayMessage(message, className = 'text-gray-800') {
            elements.gameMessage.innerHTML = `Helber: "<span class="${className}">${message}</span>"`;
        }
        function getRandomPraisePhrase() {
            return PRAISE_PHRASES[Math.floor(Math.random() * PRAISE_PHRASES.length)];
        }
        function getRandomCustomerEmoji() {
            const emojis = ['üë®', 'üë©', 'üë¥', 'üëµ', 'üßë‚Äçüç≥', 'üëÆ', 'üë®‚Äçüé§', 'üë©‚Äçü¶∞', 'üë±', 'üë®‚Äçü¶±', 'ü¶Å'];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }
        // --- Animation & FX (Mantido como estava) ---
        function animatePizzaDelivery() {
            const stack = elements.pizzaStack;
            // Anima a sa√≠da da pizza
            stack.style.transition = 'all 0.5s ease-in';
            stack.style.transform = 'translateY(-200px) rotate(30deg) scale(0.5)';

            setTimeout(() => {
                resetPizzaBench();
                // Restaura o estado inicial (invis√≠vel) para a pr√≥xima transi√ß√£o
                stack.style.transform = 'translateY(0) rotate(0) scale(1)';
                setTimeout(() => {
                    stack.style.transition = 'all 0.2s ease-out';
                }, 50);
            }, 500);
        }

        function animatePizzaExplosion() {
            const stack = elements.pizzaStack;
            // Simula uma explos√£o de ingredientes no lugar
            stack.style.transition = 'all 0.1s ease-out';
            stack.style.transform = 'scale(1.1) rotate(5deg)';
            
            const fireworkContainer = document.createElement('div');
            fireworkContainer.style.position = 'absolute';
            fireworkContainer.style.left = stack.offsetLeft + stack.offsetWidth / 2 + 'px';
            fireworkContainer.style.top = stack.offsetTop + stack.offsetHeight / 2 + 'px';
            fireworkContainer.style.zIndex = '5';
            document.body.appendChild(fireworkContainer);

            for (let i = 0; i < 15; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.width = '5px';
                firework.style.height = '5px';
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 50 + 20;
                const x = Math.cos(angle) * distance + 'px';
                const y = Math.sin(angle) * distance + 'px';
                firework.style.setProperty('--x', x);
                firework.style.setProperty('--y', y);
                firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                fireworkContainer.appendChild(firework);
                setTimeout(() => firework.remove(), 800);
            }

            setTimeout(() => {
                resetPizzaBench();
                stack.style.transform = 'scale(1) rotate(0)';
                fireworkContainer.remove();
            }, 500);
        }
        
        function animateFireworks() {
            const container = document.body;
            for (let i = 0; i < 20; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                const x = (Math.random() * 200 - 100) + 'px';
                const y = (Math.random() * 200 - 100) + 'px';
                firework.style.left = `${Math.random() * 100}%`;
                firework.style.top = `${Math.random() * 100}%`;
                firework.style.setProperty('--x', x);
                firework.style.setProperty('--y', y);
                firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                container.appendChild(firework);

                setTimeout(() => firework.remove(), 800);
            }
        }


        // --- Event Listeners and Initialization ---

        function initEventListeners() {
            elements.deliverBtn.addEventListener('click', deliverPizza);
            elements.startGameBtn.addEventListener('click', startGame);
        }

        function init() {
            initFirebase();
            initEventListeners();
            showModal("Pizzaria Helber B ", "Pressione Iniciar para come√ßar sua jornada como o Pizzaiolo Helber B!", 'initial');
        }

        // Execu√ß√£o do script
        init();

    </script>
</body>
</html>
