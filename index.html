<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçï Pizzaria Master Chef Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF5733; /* Vermelho/Laranja de Pizza */
            --secondary: #FFC300; /* Amarelo de Queijo */
            --tertiary: #4CAF50; /* Verde de Ingredientes Frescos */
            --bg-dark: #333333; /* Fundo mais escuro para contraste */
        }
        body {
            font-family: 'Balsamiq Sans', cursive;
            background: linear-gradient(135deg, #f3ffec 0%, #e0e7ff 100%); /* Fundo Gradiente Suave */
            min-height: 100vh;
        }

        /* Estilo Principal dos Pain√©is */
        .game-panel {
            background-color: white;
            border-radius: 1.5rem; /* Bordas mais suaves */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Sombra mais profunda */
            transition: transform 0.3s ease;
            border: 3px solid var(--primary);
        }

        /* T√≠tulo Tem√°tico */
        .header-title {
            text-shadow: 3px 3px 0px var(--secondary);
            letter-spacing: 2px;
        }

        /* Bot√µes de A√ß√£o Principal */
        .btn-action {
            transition: all 0.2s ease-in-out;
            border: 2px solid #333;
            box-shadow: 4px 4px 0px #333;
            position: relative; /* Para o r√≥tulo de 'PR√ìXIMO' */
        }
        .btn-action:hover:not(:disabled) {
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0px #333;
        }
        .btn-action:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #333;
        }
        .btn-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: 2px 2px 0px #999;
        }

        /* Design da Bancada da Pizza (Simulado) */
        #pizza-workbench {
            min-height: 300px;
            background-color: #FEEBC3; /* Cor da massa */
            border: 12px solid #D69E2E; /* Borda da massa (Crosta) */
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2); /* Efeito de profundidade na massa */
            position: relative;
            overflow: hidden;
            border-radius: 50%; /* Tornar a bancada redonda */
            background-image: radial-gradient(circle at center, #FFEFD5 0%, #FEEBC3 70%);
        }

        /* Camadas de Ingredientes (Visualmente mais ricas) */
        .ingredient-layer {
            position: absolute;
            top: 5%; left: 5%;
            width: 90%; height: 90%;
            border-radius: 50%;
            opacity: 0.8;
            transition: all 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        /* Defini√ß√µes visuais para cada ingrediente */
        .i-sauce { background: linear-gradient(to top right, #E53E3E, #C53030); z-index: 10; }
        .i-cheese { background: linear-gradient(to top left, #F6E05E, #ECC94B); z-index: 20; }
        .i-pepperoni { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="4" fill="%239B2C2C"/></svg>') repeat; background-color: transparent; opacity: 1; z-index: 30;}
        .i-olives { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><circle cx="6" cy="6" r="5" fill="%234A5568"/><circle cx="6" cy="6" r="2" fill="white"/></svg>') repeat; background-color: transparent; opacity: 1; z-index: 40; }
        .i-mushrooms { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15"><path d="M7.5 0 L15 7.5 L7.5 15 L0 7.5 Z" fill="%23713F12" opacity="0.7"/></svg>') repeat; background-color: transparent; opacity: 1; z-index: 50; }


        /* Estilizando o HUD (Cabe√ßalho) */
        .hud-header {
            background: linear-gradient(to right, #FF7043, #FF5722); /* Gradiente Vibrante */
            color: white;
            border: 4px solid #D32F2F;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        .stat-value {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Estilo da Fila de Pedidos */
        .order-card {
            border-left-width: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .order-card[data-status="Preparing"] {
            border-color: var(--secondary);
            background-color: #FFF3CD;
            transform: scale(1.02); /* Destacar pedido ativo */
        }
        .order-card[data-status="Pending"] {
            border-color: var(--primary);
            background-color: #FFE0B2;
        }

        /* Estilo do Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            animation: modal-pop 0.3s ease-out;
        }
        @keyframes modal-pop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

<header class="max-w-7xl mx-auto p-4 rounded-3xl mb-8 sticky top-4 z-20 hud-header">
    <h1 class="text-4xl sm:text-5xl font-extrabold text-white text-center mb-4 header-title">üçï PIZZARIA MASTER SIMULATOR</h1>
    <div id="stats-panel" class="flex flex-wrap justify-between items-center text-center">
        <div class="stat p-2 sm:p-4 w-1/4">
            <p class="text-xs sm:text-sm font-bold opacity-80">DIA</p>
            <p id="stat-day" class="text-2xl sm:text-4xl font-extrabold stat-value">1</p>
        </div>
        <div class="stat p-2 sm:p-4 w-1/4">
            <p class="text-xs sm:text-sm font-bold opacity-80">CAIXA</p>
            <p id="stat-cash" class="text-2xl sm:text-4xl font-extrabold text-green-300 stat-value">‚Ç¨100.00</p>
        </div>
        <div class="stat p-2 sm:p-4 w-1/4">
            <p class="text-xs sm:text-sm font-bold opacity-80">INGREDIENTES</p>
            <p id="stat-ingredients" class="text-2xl sm:text-4xl font-extrabold text-yellow-300 stat-value">10</p>
        </div>
        <div class="stat p-2 sm:p-4 w-1/4">
            <p class="text-xs sm:text-sm font-bold opacity-80">REPUTA√á√ÉO</p>
            <p id="stat-reputation" class="text-2xl sm:text-4xl font-extrabold text-red-100 stat-value">‚≠ê‚≠ê‚≠ê</p>
        </div>
    </div>
    <div id="time-bar" class="w-full bg-red-800 rounded-full h-3 mt-4 overflow-hidden shadow-inner">
        <div id="time-progress" class="h-3 bg-yellow-400 transition-none" style="width: 0%"></div>
    </div>
</header>

<main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

    <section id="management-col" class="lg:col-span-1 game-panel p-6">
        <h2 class="text-3xl font-bold mb-4 border-b-4 border-dashed pb-2 text-primary">üìú Flyer de Receitas</h2>
        
        <div class="mb-8 p-4 bg-gray-100 rounded-xl border border-gray-300">
            <h3 class="text-xl font-bold mb-3">üì¶ Estocar Ingredientes</h3>
            <p class="text-sm text-gray-600 mb-3">Custo: ‚Ç¨20 / +5 unidades (Mantenha o stock cheio!)</p>
            <button id="buy-ingredients" class="btn-action w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl">
                Comprar Agora
            </button>
        </div>

        <h3 class="text-2xl font-bold mb-4 text-tertiary">‚≠ê Receitas Secretas</h3>
        <div id="menu-list" class="space-y-4">
            </div>
    </section>

    <section id="kitchen-col" class="lg:col-span-2 game-panel p-6">
        <h2 class="text-3xl font-bold mb-6 text-primary border-b-4 border-double pb-2">üë®‚Äçüç≥ Bancada do Pizzaiolo</h2>
        
        <div id="pizza-workbench" class="w-full h-80 rounded-full mx-auto mb-6 relative">
            <p id="workbench-message" class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-gray-600 opacity-50 select-none">PIZZA AQUI</p>
            </div>

        <div id="kitchen-status" class="bg-gray-100 p-4 rounded-xl border-4 border-dashed border-gray-300 mb-6">
            <p id="kitchen-status-text" class="text-xl font-bold text-gray-800 text-center">A Cozinha est√° livre.</p>
            <button id="serve-pizza-btn" class="hidden btn-action mt-4 bg-tertiary hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl w-full text-xl">
                Assar & Entregar! üöÄ
            </button>
        </div>
        
        <h3 class="text-2xl font-bold mb-4 text-primary">üçÖ Selecionar Ingredientes</h3>
        <div id="ingredient-controls" class="grid grid-cols-3 sm:grid-cols-5 gap-4">
            </div>

    </section>

    <section id="orders-col" class="lg:col-span-1 game-panel p-6 lg:order-last">
        <h2 class="text-3xl font-bold mb-4 border-b-4 border-dashed pb-2 text-primary">‚è≥ Fila de Clientes</h2>
        <div id="orders-list" class="space-y-4">
            <p id="no-orders" class="col-span-full text-center text-gray-500 italic p-8">Aguardando novos pedidos...</p>
        </div>
    </section>
</main>

<div id="game-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay transition-opacity duration-300">
    <div class="modal-content bg-white p-6 sm:p-10 rounded-3xl shadow-2xl max-w-lg w-full text-center transform border-4 border-red-500">
        <h3 id="modal-title" class="text-3xl font-extrabold mb-4 text-red-700"></h3>
        <p id="modal-body" class="text-lg text-gray-700 mb-8 whitespace-pre-line"></p>
        <button id="modal-close-btn" class="btn-action bg-primary hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl w-full text-xl">
            Continuar
        </button>
    </div>
</div>

<script>
    // --- Estrutura de Dados do Jogo (Mantida e Melhorada) ---
    const GAME_SPEED = 50; // Tempo em milissegundos por Tick de jogo (50ms)
    const DAY_DURATION_TICKS = 1500; // 1500 ticks = 75 segundos por dia (1500 * 50ms = 75000ms)
    const MAX_ORDERS = 6; // Limite de pedidos na fila

    let gameState = {
        day: 1,
        time: 0, 
        cash: 100.00,
        reputation: 3, 
        ingredients: 10,
        gameOver: false,
        totalServed: 0,
    };

    // Estrutura do Menu e Ingredientes
    const INGREDIENTS = [
        { id: 'sauce', name: 'Molho üçÖ', reqId: 'i-sauce', cost: 1, emoji: 'ü•´', color: 'bg-red-600' },
        { id: 'cheese', name: 'Queijo üßÄ', reqId: 'i-cheese', cost: 1.5, emoji: 'üßÄ', color: 'bg-yellow-400' },
        { id: 'pepperoni', name: 'Pepperoni ü•ì', reqId: 'i-pepperoni', cost: 2, emoji: 'ü•ì', color: 'bg-red-800' },
        { id: 'olives', name: 'Azeitona ü´í', reqId: 'i-olives', cost: 1.2, emoji: 'ü´í', color: 'bg-gray-900' },
        { id: 'mushrooms', name: 'Cogumelo üçÑ', reqId: 'i-mushrooms', cost: 1.1, emoji: 'üçÑ', color: 'bg-yellow-800' },
    ];

    const MENU = [
        { id: 'mrg', name: 'Margherita', cost: 5, price: 12.50, prepTime: 50, reqIng: 1, recipe: ['sauce', 'cheese'] },
        { id: 'pep', name: 'Pepperoni', cost: 7, price: 15.00, prepTime: 70, reqIng: 2, recipe: ['sauce', 'cheese', 'pepperoni'] },
        { id: 'veg', name: 'Vegetariana', cost: 6, price: 13.00, prepTime: 60, reqIng: 1, recipe: ['sauce', 'cheese', 'olives', 'mushrooms'] },
    ];

    let orders = [];
    let activeOrder = null; // O pedido que est√° sendo *trabalhado* (clicando nos ingredientes)
    let currentPizza = []; // Ingredientes j√° colocados
    let lastOrderTime = 0;

    // --- Fun√ß√µes de Ajuda UI ---

    function showModal(title, body, onClose = null) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = body;
        document.getElementById('game-modal').classList.remove('hidden');
        document.getElementById('modal-close-btn').onclick = () => {
            document.getElementById('game-modal').classList.add('hidden');
            if (onClose) onClose();
        };
    }

    // Inicializa√ß√£o do sistema de mensagens (substitui alert)
    function setMessage(msg) {
        const messageBox = document.createElement('div');
        let color = 'bg-gray-700';
        if (msg.type === 'success') color = 'bg-green-600';
        else if (msg.type === 'error' || msg.type === 'warning') color = 'bg-red-600';
        else if (msg.type === 'info') color = 'bg-blue-600';
        
        messageBox.className = `fixed bottom-4 right-4 p-4 rounded-xl shadow-xl text-white font-bold transition-opacity duration-300 z-50 ${color}`;
        messageBox.textContent = msg.text;
        document.body.appendChild(messageBox);

        setTimeout(() => {
            messageBox.style.opacity = '0';
            setTimeout(() => messageBox.remove(), 300);
        }, 3000);
    }

    function getReputationStars(rep) {
        return '‚≠ê'.repeat(rep) + '‚òÜ'.repeat(5 - rep);
    }

    function updateStatsUI() {
        document.getElementById('stat-day').textContent = gameState.day;
        document.getElementById('stat-cash').textContent = `‚Ç¨${gameState.cash.toFixed(2)}`;
        document.getElementById('stat-ingredients').textContent = gameState.ingredients;
        document.getElementById('stat-reputation').textContent = getReputationStars(gameState.reputation);
        const progress = (gameState.time / DAY_DURATION_TICKS) * 100;
        document.getElementById('time-progress').style.width = `${progress}%`;
    }

    function updateMenuUI() {
        const menuList = document.getElementById('menu-list');
        menuList.innerHTML = MENU.map(pizza => `
            <div class="p-4 bg-white rounded-xl shadow-lg border-l-4 border-secondary transition duration-300 hover:shadow-xl">
                <p class="font-bold text-lg text-gray-800">${pizza.name} - ‚Ç¨${pizza.price.toFixed(2)}</p>
                <p class="text-sm text-gray-600 mt-1">
                    Receita: ${pizza.recipe.map(id => INGREDIENTS.find(i => i.id === id).emoji).join(' ‚Üí ')}
                </p>
                <p class="text-xs text-gray-500 mt-1">Ingredientes: ${pizza.recipe.length} unidades | Tempo: ${pizza.prepTime} ticks</p>
            </div>
        `).join('');
    }

    function updateOrdersUI() {
        const ordersList = document.getElementById('orders-list');
        const noOrders = document.getElementById('no-orders');
        ordersList.innerHTML = '';
        if (orders.length === 0) {
            noOrders.classList.remove('hidden');
        } else {
            noOrders.classList.add('hidden');
            orders.forEach(order => {
                const timeElapsed = gameState.time - order.arrivalTime;
                const timeFraction = timeElapsed / order.patience;
                const timePercent = Math.min(timeFraction * 100, 100);
                const isOverdue = timeFraction >= 1;
                const timeColor = isOverdue ? 'bg-red-500' : (timePercent > 75 ? 'bg-yellow-500' : 'bg-green-500');

                ordersList.innerHTML += `
                    <div id="order-${order.id}" class="order-card p-4 rounded-xl transition duration-300 ${activeOrder && activeOrder.id === order.id ? 'border-4 border-double border-red-500 shadow-2xl' : 'bg-white'}"
                        data-order-id="${order.id}" data-status="${order.status}">
                        <p class="font-extrabold text-xl text-gray-900">${order.pizza.name} - Cliente #${order.id.substring(0, 4)}</p>
                        <p class="text-sm font-semibold text-gray-600 mt-1">Status: ${activeOrder && activeOrder.id === order.id ? 'üëâ EM PREPARO' : '‚è≥ PENDENTE'}</p>
                        <div class="mt-2 text-xs font-bold">
                            Paci√™ncia:
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                <div class="h-2 ${timeColor}" style="width: ${100 - timePercent}%"></div>
                            </div>
                            ${isOverdue ? '<span class="text-red-500">PERDIDO! üò°</span>' : ''}
                        </div>
                        ${(!activeOrder || activeOrder.id !== order.id) ? `
                        <button onclick="startPrep('${order.id}')" class="btn-action mt-3 w-full bg-secondary hover:bg-yellow-600 text-black font-bold py-2 px-3 rounded-xl text-sm" ${isOverdue ? 'disabled' : ''}>
                            Pegar Pedido
                        </button>`
                        : ''}
                    </div>
                `;
            });
        }
    }

    function updateKitchenUI() {
        const kitchenText = document.getElementById('kitchen-status-text');
        const serveBtn = document.getElementById('serve-pizza-btn');
        const workbench = document.getElementById('pizza-workbench');
        const workbenchMsg = document.getElementById('workbench-message');
        const controls = document.getElementById('ingredient-controls');

        // Limpar a bancada, mas garantir que a mensagem de placeholder √© recriada/vis√≠vel
        workbench.innerHTML = '<p id="workbench-message" class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-gray-600 opacity-50 select-none">PIZZA AQUI</p>';
        
        controls.innerHTML = '';
        serveBtn.classList.add('hidden');
        document.getElementById('workbench-message').classList.remove('hidden');


        if (activeOrder) {
            document.getElementById('workbench-message').classList.add('hidden');
            kitchenText.textContent = `Montando ${activeOrder.pizza.name} (${currentPizza.length} / ${activeOrder.pizza.recipe.length} passos)`;

            // 1. Renderizar Ingredientes na Bancada
            currentPizza.forEach(ingId => {
                const req = INGREDIENTS.find(i => i.id === ingId);
                // Adiciona a camada √† bancada. Note que o workbench √© re-limpo no in√≠cio desta fun√ß√£o.
                workbench.innerHTML += `<div class="ingredient-layer ${req.reqId}"></div>`;
            });

            // 2. Criar Bot√µes de Ingredientes
            INGREDIENTS.forEach(ing => {
                const nextRequired = activeOrder.pizza.recipe[currentPizza.length];
                const isNext = ing.id === nextRequired;
                const isComplete = currentPizza.length === activeOrder.pizza.recipe.length;

                // Bot√£o principal para o pr√≥ximo ingrediente
                const buttonHtml = `
                    <button onclick="addIngredient('${ing.id}')" 
                            class="btn-action p-3 rounded-xl text-center ${isNext && !isComplete ? 'bg-tertiary text-white' : 'bg-gray-200 text-gray-800'}"
                            ${isNext && !isComplete ? '' : 'disabled'}>
                        <span class="text-4xl block">${ing.emoji}</span>
                        <span class="text-xs font-bold">${ing.name.split(' ')[0]}</span>
                        ${isNext && !isComplete ? '<span class="text-xs font-extrabold text-yellow-300 absolute top-1 right-1 transform -rotate-12 bg-red-600 px-1 rounded">PR√ìXIMO!</span>' : ''}
                    </button>
                `;
                controls.innerHTML += buttonHtml;
            });
            
            // 3. Mostrar bot√£o de servir se completo
            if (currentPizza.length === activeOrder.pizza.recipe.length) {
                kitchenText.textContent = `Aguardando para Assar ${activeOrder.pizza.name}. Clique em Entregar!`;
                serveBtn.classList.remove('hidden');
                serveBtn.onclick = () => servePizza();
            }

        } else {
            // Garante que a mensagem de placeholder √© vis√≠vel quando n√£o h√° pedido ativo
            document.getElementById('workbench-message').classList.remove('hidden');
            kitchenText.textContent = "A Cozinha est√° livre. Escolha um pedido para come√ßar!";
        }
    }
    
    // --- Fun√ß√µes de Jogo ---

    function generateOrder() {
        // Probabilidade de um pedido aumentar com a reputa√ß√£o e limitar a fila
        const chance = 0.05 + (gameState.reputation * 0.015);
        if (Math.random() > chance || orders.length >= MAX_ORDERS || activeOrder) return;

        if (gameState.time - lastOrderTime < 10) return; // Limitar taxa de chegada

        const pizza = MENU[Math.floor(Math.random() * MENU.length)];
        const newOrder = {
            id: crypto.randomUUID(),
            pizza: pizza,
            status: 'Pending',
            arrivalTime: gameState.time,
            patience: DAY_DURATION_TICKS * (0.1 + Math.random() * 0.3), // 10% a 30% da dura√ß√£o do dia
        };

        orders.push(newOrder);
        lastOrderTime = gameState.time;
        setMessage({ type: 'info', text: `üîî Novo Pedido: ${pizza.name} chegou!` });
    }

    function startPrep(orderId) {
        if (activeOrder) {
            showModal("Cozinha Ocupada", "J√° est√° a trabalhar numa pizza! Termine essa primeiro.");
            return;
        }

        const orderIndex = orders.findIndex(o => o.id === orderId);
        const order = orders[orderIndex];

        // Se o cliente perdeu a paci√™ncia, n√£o se pode pegar o pedido
        const timeElapsed = gameState.time - order.arrivalTime;
        if (timeElapsed > order.patience) {
            setMessage({ type: 'error', text: 'Tarde demais! O cliente j√° se foi. üòî' });
            orders.splice(orderIndex, 1);
            gameState.reputation = Math.max(1, gameState.reputation - 1);
            updateOrdersUI();
            updateStatsUI();
            return;
        }

        // Verificar ingredientes (custo total da receita)
        if (gameState.ingredients < order.pizza.recipe.length) {
            showModal("Falta de Ingredientes üò±", `Precisa de ${order.pizza.recipe.length} unidades de ingredientes para a ${order.pizza.name}. Compre mais!`);
            return;
        }

        // Iniciar a prepara√ß√£o
        gameState.ingredients -= order.pizza.recipe.length; // Consome todos os ingredientes da receita no in√≠cio
        order.status = 'Preparing';
        activeOrder = order;
        currentPizza = []; // Limpa a pizza atual
        
        // Move o pedido ativo para o topo da lista (visual)
        orders.splice(orderIndex, 1);
        orders.unshift(activeOrder);

        updateStatsUI();
        updateOrdersUI();
        updateKitchenUI();
        setMessage({ type: 'success', text: `üî• Come√ßando: ${activeOrder.pizza.name}. Aten√ß√£o √† ORDEM!` });
    }

    function addIngredient(ingId) {
        if (!activeOrder) {
            setMessage({ type: 'error', text: 'Nenhum pedido ativo!' });
            return;
        }

        const requiredIngredient = activeOrder.pizza.recipe[currentPizza.length];

        if (ingId === requiredIngredient) {
            currentPizza.push(ingId); // Adiciona o ingrediente correto
            setMessage({ type: 'success', text: `${INGREDIENTS.find(i => i.id === ingId).emoji} Ingrediente correto adicionado!` });
        } else {
            // Falha: Cliente insatisfeito, penaliza√ß√£o de reputa√ß√£o
            const ingName = INGREDIENTS.find(i => i.id === ingId).name.split(' ')[0];
            const requiredName = INGREDIENTS.find(i => i.id === requiredIngredient).name.split(' ')[0];

            gameState.reputation = Math.max(1, gameState.reputation - 1);
            setMessage({ type: 'error', text: `ERRO! ‚ùå Colocou ${ingName} em vez de ${requiredName}. Cliente furioso!` });

            // Limpa e move o pedido para o fim da fila ou remove
            activeOrder.status = 'Failed';
            
            // Reembolsa os ingredientes para n√£o penalizar em excesso (opcional)
            // gameState.ingredients += activeOrder.pizza.recipe.length;

            activeOrder = null;
            currentPizza = [];

            // A ordem falhada √© removida da fila
            orders.shift();

            updateStatsUI();
            updateOrdersUI();
        }
        updateKitchenUI();
    }

    function servePizza() {
        if (!activeOrder || currentPizza.length !== activeOrder.pizza.recipe.length) {
            showModal("Ainda N√£o Est√° Pronta", "A pizza n√£o est√° completa. Adicione todos os ingredientes!");
            return;
        }
        
        const order = activeOrder;
        const timeSinceArrival = gameState.time - order.arrivalTime;
        const isLate = timeSinceArrival > order.patience;
        
        const profit = order.pizza.price;
        gameState.cash += profit;
        gameState.totalServed++;

        let modalTitle = `Pedido Conclu√≠do ‚úÖ`;
        let modalBody = `Pizza ${order.pizza.name} servida a tempo! Lucro: ‚Ç¨${(profit).toFixed(2)}`;

        if (isLate) {
            gameState.reputation = Math.max(1, gameState.reputation - 1);
            modalTitle = `Pizza Servida Tarde üòü`;
            modalBody = `O cliente pagou (‚Ç¨${profit.toFixed(2)}), mas saiu insatisfeito com a demora. A reputa√ß√£o caiu para ${getReputationStars(gameState.reputation)}!`;
        } else if (Math.random() < 0.25) { 
            // B√≥nus de reputa√ß√£o por servi√ßo r√°pido
            gameState.reputation = Math.min(5, gameState.reputation + 1);
            modalTitle = `Servi√ßo TOP! ü§©`;
            modalBody = `Uau! A pizza ${order.pizza.name} foi um sucesso! Reputa√ß√£o Aumentou para ${getReputationStars(gameState.reputation)}. Lucro: ‚Ç¨${(profit).toFixed(2)}`;
        }

        showModal(modalTitle, modalBody, () => {
            activeOrder = null;
            orders.shift(); // Remove o pedido
            updateStatsUI();
            updateOrdersUI();
            updateKitchenUI();
        });
    }

    function endOfDay() {
        const missedOrders = orders.length + (activeOrder ? 1 : 0); // Pedidos que sobraram
        
        const finalCash = gameState.cash;
        
        // Tentativa de obter o caixa inicial do dia anterior (para c√°lculo do lucro l√≠quido)
        const initialCash = localStorage.getItem('lastDayCash') ? parseFloat(localStorage.getItem('lastDayCash')) : 100.00; 
        const netProfit = finalCash - initialCash;

        if (missedOrders > 0) {
            // Penaliza√ß√£o maior por pedidos que sobraram
            gameState.reputation = Math.max(1, gameState.reputation - Math.ceil(missedOrders / 2));
        }

        if (gameState.cash < 0 && gameState.day > 1) {
            gameState.gameOver = true;
            showModal("FAL√äNCIA! üò≠", 
                     `Caixa Final: ‚Ç¨${finalCash.toFixed(2)}\n\nO dinheiro acabou! A sua pizzaria n√£o sobreviveu ao Dia ${gameState.day}. Tente de novo e seja mais r√°pido!`, 
                     initializeGame);
            return;
        }
        
        // Guardar o caixa final para ser o inicial do pr√≥ximo dia
        localStorage.setItem('lastDayCash', gameState.cash.toFixed(2));
        localStorage.setItem('reputation', gameState.reputation);
        localStorage.setItem('ingredients', gameState.ingredients);

        showModal(
            `Dia ${gameState.day} Conclu√≠do! üåô`,
            `üçï Pizzas Servidas: ${gameState.totalServed}\nPedidos Perdidos/N√£o Servidos: ${missedOrders}\n\nCaixa Final: ‚Ç¨${finalCash.toFixed(2)}\nLucro L√≠quido do Dia: ‚Ç¨${netProfit.toFixed(2)}\nReputa√ß√£o: ${getReputationStars(gameState.reputation)}\n\nPreparado para o Dia ${gameState.day + 1}?`,
            startNewDay
        );
    }

    function buyIngredients() {
        const cost = 20.00;
        const quantity = 5;

        if (gameState.cash < cost) {
            setMessage({ type: 'error', text: "üí∏ N√£o tem dinheiro suficiente (‚Ç¨20.00)!" });
            return;
        }

        gameState.cash -= cost;
        gameState.ingredients += quantity;
        updateStatsUI();
        setMessage({ type: 'info', text: `Ingredientes comprados! -‚Ç¨${cost.toFixed(2)} (+${quantity} uni.)` });
    }

    // --- Ciclo Principal do Jogo ---

    let gameLoopInterval;

    function gameLoop() {
        if (gameState.gameOver) {
            clearInterval(gameLoopInterval);
            return;
        }
        gameState.time++;

        // 1. Gera√ß√£o de Pedidos
        generateOrder();

        // 2. Verifica√ß√£o de Paci√™ncia
        let ordersMissed = 0;
        orders = orders.filter(order => {
            if (activeOrder && activeOrder.id === order.id) return true; // Ignora o pedido ativo na bancada
            
            const timeElapsed = gameState.time - order.arrivalTime;
            if (timeElapsed > order.patience) {
                ordersMissed++;
                setMessage({ type: 'warning', text: `Cliente #${order.id.substring(0, 4)} saiu sem ser atendido! Reputa√ß√£o caiu!` });
                return false; // Remove order
            }
            return true; // Keep order
        });

        if (ordersMissed > 0) {
             gameState.reputation = Math.max(1, gameState.reputation - ordersMissed);
        }

        // 3. Atualiza√ß√µes UI
        updateStatsUI();
        updateOrdersUI();

        // 4. Fim do Dia
        if (gameState.time >= DAY_DURATION_TICKS) {
            clearInterval(gameLoopInterval);
            endOfDay();
        }
    }

    function startNewDay() {
        gameState.day++;
        gameState.time = 0;
        gameState.totalServed = 0;
        orders = []; 
        activeOrder = null;
        currentPizza = [];
        lastOrderTime = 0;
        
        // Carregar estado persistido
        gameState.cash = localStorage.getItem('lastDayCash') ? parseFloat(localStorage.getItem('lastDayCash')) : 100.00;
        gameState.reputation = localStorage.getItem('reputation') ? parseInt(localStorage.getItem('reputation')) : 3;
        gameState.ingredients = localStorage.getItem('ingredients') ? parseInt(localStorage.getItem('ingredients')) : 10;

        updateStatsUI();
        updateOrdersUI(); 
        updateKitchenUI();

        gameLoopInterval = setInterval(gameLoop, GAME_SPEED);
        setMessage({ type: 'info', text: `‚≠ê Bem-vindo ao Dia ${gameState.day}! A loja abriu!` });
    }

    function initializeGame() {
        // Resetar estado inicial e persistido
        localStorage.removeItem('lastDayCash'); 
        localStorage.removeItem('reputation');
        localStorage.removeItem('ingredients');

        gameState = {
            day: 1,
            time: 0,
            cash: 100.00,
            reputation: 3,
            ingredients: 10,
            gameOver: false,
            totalServed: 0,
        };
        orders = [];
        activeOrder = null;
        currentPizza = [];
        lastOrderTime = 0;

        // Configurar Listeners
        document.getElementById('buy-ingredients').onclick = buyIngredients;
        
        // Iniciar o jogo
        updateMenuUI();
        // O startNewDay() chama o gameLoop
        startNewDay(); 
    }

    window.onload = initializeGame;
</script>
</body>
</html>
