<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria Helber B - Australian Man</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'aussie-orange': '#D96E01',
                        'aussie-green': '#00843D',
                        'bancada-brown': '#6D4C41',
                        'fundo-claro': '#FFF5E6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS para o tema Aussie */
        body {
            background-color: #f0f0f0;
            font-family: 'Inter', sans-serif;
        }

        /* Anima√ß√£o do fundo Aussie/R√∫stico */
        .aussie-background {
            /* Adicionei uma imagem de background placeholder. Voc√™ pode mudar para uma imagem r√∫stica real de pizza. */
            background-image: url('https://placehold.co/1920x1080/D96E01/FFFFFF?text=FUNDO+R%C3%9ASTICO+PIZZARIA+AUSTRALIANA');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            z-index: 1;
        }

        .aussie-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            /* Camada de opacidade para a UI */
            z-index: 2;
        }

        #game-ui {
            z-index: 3;
            position: relative;
        }

        /* Estilo da Bancada da Pizza */
        #pizza-bench {
            background-color: #bcaaa4;
            /* M√°rmore claro/madeira */
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Estilo do Helber (Texto/Emoji) */
        #helber-avatar {
            font-size: 3rem;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }

        /* Bot√£o de Ingrediente */
        .ingredient-btn {
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
        }
        .ingredient-btn:active {
            transform: scale(0.95);
            box-shadow: none;
        }

        /* Pizza Stack - Visual Feedback */
        #pizza-stack {
            min-height: 200px;
            display: flex;
            flex-direction: column-reverse;
            /* Empilha de baixo para cima */
            align-items: center;
            justify-content: center;
        }
        .pizza-layer {
            width: 90%;
            height: 20px;
            border-radius: 50%;
            margin-top: -10px;
            /* Sobrep√µe as camadas */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease-out;
        }
        .layer-molho {
            background-color: #c0392b;
        }
        .layer-queijo {
            background-color: #f1c40f;
        }
        .layer-carne {
            background-color: #8B4513;
        }
        .layer-vegetal {
            background-color: #27ae60;
        }
        .layer-premium {
            background-color: #9b59b6;
        }
        .layer-abacaxi {
            background-color: #f39c12;
        }


        /* Foguetes de Artif√≠cio (Vit√≥ria) */
        .firework {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            opacity: 0;
            animation: firework-burst 0.8s ease-out forwards;
        }

        @keyframes firework-burst {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) scale(0.5);
            }
        }

        /* Timer Bar */
        #timer-bar-fill {
            /* Transi√ß√£o ajustada para dar a sensa√ß√£o de crescimento/ac√∫mulo */
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="aussie-background min-h-screen p-4 md:p-8">

    <div id="game-ui" class="max-w-7xl mx-auto">
        <header class="bg-white/90 p-4 mb-6 rounded-xl shadow-lg border-t-4 border-aussie-green">
            <div class="flex flex-col md:flex-row justify-between items-center text-center">
                <h1 class="text-3xl font-black text-aussie-orange uppercase tracking-wider mb-2 md:mb-0">
                    Pizzaria Helber B - Australian Man
                </h1>

                <div class="flex space-x-4 font-bold text-lg">
                    <span id="fase-counter" class="bg-aussie-green text-white px-3 py-1 rounded-full shadow-md">Fase: 1/5</span>
                    <span id="pizza-counter" class="bg-aussie-orange text-white px-3 py-1 rounded-full shadow-md">Pizzas: 0/25</span>
                    <span id="saldo-counter" class="bg-gray-700 text-white px-3 py-1 rounded-full shadow-md">Saldo: R$ 0</span>
                    <span id="highscore-display" class="bg-blue-600 text-white px-3 py-1 rounded-full shadow-md">Recorde: R$ 0</span>
                </div>
            </div>
            <div id="game-message" class="mt-3 text-center text-xl font-semibold text-gray-800">
                Helber: "G'day, mate!
                Let's make some wicked pizzas today!"
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <div class="lg:col-span-3 space-y-6">
                <div id="ingredients-shelf" class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-green">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">Ingredientes </h2>
                    <div id="ingredient-buttons" class="grid grid-cols-3 gap-2">
                    </div>
                </div>

                <div class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-orange max-h-96 overflow-y-auto">
                    <h2 class="text-xl font-bold mb-3 text-aussie-green">Receitas (Ordem Exata!) </h2>
                    <div id="recipe-list" class="text-sm font-mono text-gray-700 space-y-2">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6 flex flex-col items-center space-y-4">
                <div class="text-center">
                    <span id="helber-avatar"></span>
                    <p class="text-xl font-bold text-gray-800">Helber B.</p>
                </div>

                <div id="pizza-bench" class="w-full max-w-lg h-80 flex flex-col items-center justify-center p-4">
                    <h3 class="text-center text-lg font-semibold mb-4 text-white p-2 rounded-lg bg-gray-800/70">
                        Sua Pizza
                    </h3>
                    <div id="pizza-stack"
                        class="w-64 h-64 border-8 border-dashed border-aussie-orange/50 rounded-full bg-aussie-orange/10 flex flex-col items-center justify-center">
                        <p id="current-pizza-base" class="text-sm text-gray-600">Massa (Clique no primeiro ingrediente)</p>
                    </div>
                </div>

                <button id="deliver-btn" disabled
                    class="w-full max-w-sm bg-gray-400 text-white font-black text-xl py-3 rounded-full shadow-lg transition duration-150 hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    ENTREGAR AO CLIENTE
                </button>

                <div class="w-full max-w-lg mt-4 bg-gray-200 rounded-full h-4">
                    <div id="timer-bar-fill" class="bg-green-500 h-4 rounded-full" style="width: 0%;"></div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div id="order-queue" class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-green">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">Pr√≥ximo Pedido </h2>
                    <p id="customer-wait-timer" class="text-md font-bold text-green-600 mb-2">
                        CLIENTE AGUARDANDO A (00:00)
                    </p>
                    <div id="current-order-card"
                        class="bg-yellow-100 p-3 rounded-lg shadow-md border-l-4 border-yellow-500">
                        <p class="text-sm text-gray-500">Cliente (Aguardando Helber)</p>
                        <p id="customer-avatar" class="text-2xl mt-1"></p>
                        <p id="current-order-name" class="text-xl font-black text-red-700 mt-2">...</p>
                    </div>
                </div>

                <div id="feedback-area"
                    class="bg-white/95 p-4 rounded-xl shadow-inner border border-aussie-orange min-h-[100px]">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">Feedback </h2>
                    <p id="feedback-text" class="text-lg italic text-gray-600">Aguardando entrega...</p>
                </div>
            </div>
        </main>

        <div id="game-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div id="modal-content"
                class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center border-t-8 border-aussie-orange">
                <h2 id="modal-title" class="text-3xl font-black mb-4 text-aussie-green">Bem-vindo, Mate!</h2>
                <p id="modal-body" class="mb-6 text-gray-700">Pressione Iniciar para come√ßar sua jornada como o Pizzaiolo
                    Helber B!</p>
                <div id="modal-actions">
                    <button id="start-game-btn"
                        class="bg-aussie-orange text-white font-bold py-3 px-6 rounded-full text-lg transition duration-150 hover:bg-aussie-green">
                        Iniciar Dia 1
                    </button>
                </div>
            </div>
        </div>

    </div>

    <audio id="background-music" loop>
        <source src="The Most Popular Italian Pizza Music! Italian Tarantella Background Music For Food Videos.mp3" type="audio/mpeg">
        Seu navegador n√£o suporta o elemento de √°udio.
    </audio>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais de ambiente (PREENCHIDAS PELO CANVAS)
        const appId = typeof __app_id !== 'undefined' ?
            __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Configura√ß√µes e Vari√°veis Globais do Jogo
        let GAME_STATE = {
            currentPhase: 1,
            pizzasCompleted: 0,
            balance: 0,
            highScore: 0,
            streak: 0,
            isGameRunning: false,
            currentOrder: null,
            appliedIngredients: [],
            phaseGoal: 25,
            timerMax: 0,
            elapsedTime: 0, // ALTERADO: Contar√° o tempo que passou.
            isAuthReady: false,
            userId: null,
        };
        
        // --- ALTERA√á√ÉO 2: INCLUS√ÉO DOS EMOJIS SOLICITADOS (com adi√ß√£o dos emojis restantes) ---
        const INGREDIENTS = {
            'MOLHO': { color: '#c0392b', emoji: 'ü•´', type: 'layer-molho' },
            'QUEIJO': { color: '#f1c40f', emoji: 'üßÄ', type: 'layer-queijo' },
            'CALABRESA': { color: '#e74c3c', emoji: 'üå∂Ô∏è', type: 'layer-carne' },
            'PEPPERONI': { color: '#c0392b', emoji: 'ü•©', type: 'layer-carne' },
            'FRANGO': { color: '#f39c12', emoji: 'üçó', type: 'layer-carne' },
            'CATUPIRY': { color: '#ecf0f1', emoji: 'ü•õ', type: 'layer-queijo' },
            'MANJERIC√ÉO': { color: '#2ecc71', emoji: 'üåø', type: 'layer-vegetal' },
            'OR√âGANO': { color: '#27ae60', emoji: 'üçÉ', type: 'layer-vegetal' },
            'CEBOLA': { color: '#bdc3c7', emoji: 'üßÖ', type: 'layer-vegetal' },
            'COGUMELOS': { color: '#95a5a6', emoji: 'üçÑ', type: 'layer-vegetal' },
            'GORGONZOLA': { color: '#3498db', emoji: 'üåÄ', type: 'layer-queijo' },
            'PROVOLONE': { color: '#9b59b6', emoji: 'üíú', type: 'layer-queijo' },
            'BACON': { color: '#e67e22', emoji: 'ü•ì', type: 'layer-carne' },
            'AZEITONAS': { color: '#2c3e50', emoji: '‚ö´', type: 'layer-vegetal' },
            'PIMENT√ÉO': { color: '#e67e22', emoji: 'ü´ë', type: 'layer-vegetal' },
            'ABACAXI': { color: '#f1c40f', emoji: 'üçç', type: 'layer-abacaxi' },
            'PRESUNTO': { color: '#e67e22', emoji: 'üçñ', type: 'layer-carne' },
            'PARMES√ÉO': { color: '#f39c12', emoji: 'üîÜ', type: 'layer-queijo' },
            'BR√ìCOLIS': { color: '#2ecc71', emoji: 'ü•¶', type: 'layer-vegetal' },
            'QUEIJO EXTRA': { color: '#f1c40f', emoji: 'üßÄ+', type: 'layer-queijo' },
            'CARNE MO√çDA': { color: '#8B4513', emoji: 'ü•©-', type: 'layer-carne' },
            'ATUM': { color: '#2c3e50', emoji: 'üêü', type: 'layer-carne' },
            'ESCARGOT': { color: '#9b59b6', emoji: 'üêå', type: 'layer-premium' },
        };
        // --------------------------------------------------
        
        const RECIPES = {
            'MARGHERITA': { ingredients: ['MOLHO', 'QUEIJO', 'MANJERIC√ÉO'], price: 50, phaseMin: 1 },
            'CALABRESA': { ingredients: ['MOLHO', 'QUEIJO', 'CALABRESA', 'CEBOLA'], price: 60, phaseMin: 1 },
            'FRANGO CATUPIRY': { ingredients: ['MOLHO', 'QUEIJO', 'FRANGO', 'CATUPIRY'], price: 70, phaseMin: 1 },
            'PEPPERONI': { ingredients: ['MOLHO', 'QUEIJO', 'PEPPERONI', 'OR√âGANO'], price: 75, phaseMin: 1 },
            'BACON': { ingredients: ['MOLHO', 'QUEIJO', 'BACON', 'CEBOLA'], price: 70, phaseMin: 1 },
            'QUATRO QUEIJOS': { ingredients: ['MOLHO', 'QUEIJO', 'GORGONZOLA', 'PROVOLONE', 'PARMES√ÉO'], price: 90, phaseMin: 2 },
            'COGUMELOS': { ingredients: ['MOLHO', 'QUEIJO', 'COGUMELOS', 'MANJERIC√ÉO'], price: 65, phaseMin: 2 },
            'HAWAIIAN': { ingredients: ['MOLHO', 'QUEIJO', 'PRESUNTO', 'ABACAXI'], price: 80, phaseMin: 2 },
            'AZEITONA': { ingredients: ['MOLHO', 'QUEIJO', 'AZEITONAS', 'PIMENT√ÉO'], price: 60, phaseMin: 3 },
            'BR√ìCOLIS': { ingredients: ['MOLHO', 'QUEIJO', 'BR√ìCOLIS', 'QUEIJO EXTRA'], price: 85, phaseMin: 3 },
            'CARNE': { ingredients: ['MOLHO', 'QUEIJO', 'CARNE MO√çDA', 'CEBOLA'], price: 70, phaseMin: 4 },
            'ATUM': { ingredients: ['MOLHO', 'QUEIJO', 'ATUM', 'OR√âGANO'], price: 65, phaseMin: 4 },
            'ESCARGOT': { ingredients: ['MOLHO', 'QUEIJO', 'ESCARGOT', 'MANJERIC√ÉO'], price: 120, phaseMin: 5 }, // Premium
            'VEGETARIANA': { ingredients: ['MOLHO', 'QUEIJO', 'PIMENT√ÉO', 'COGUMELOS', 'ABACAXI'], price: 95, phaseMin: 5 },
            'SUPREMA': { ingredients: ['MOLHO', 'QUEIJO', 'PEPPERONI', 'BACON', 'COGUMELOS', 'PIMENT√ÉO'], price: 110, phaseMin: 5 },
        };
        const PHASES = {
            1: { goal: 2, timer: 0, available: ['MARGHERITA', 'CALABRESA', 'FRANGO CATUPIRY', 'PEPPERONI', 'BACON'], message: "Dia de treino! Sem press√£o, mate!" }, // Reduzido goal para teste
            2: { goal: 5, timer: 120, available: 8, message: "Aperta o passo! O rel√≥gio est√° correndo, cobber!" }, // Reduzido goal para teste
            3: { goal: 5, timer: 105, available: 12, message: "A clientela est√° agitada, menos tempo para errar!" },
            4: { goal: 5, timer: 90, available: 15, message: "Dia de super-pico! Pedidos piscando!" },
            5: { goal: 5, timer: 75, available: 15, message: "Final do campeonato! Acerto triplo √© dinheiro extra!" },
        };

        // Frases de elogio expandidas com o tema Brasil/S√£o Paulo
        const PRAISE_PHRASES = [
            "Deliciosa mate!", "Perfeita, cobber!", "A melhor da Austr√°lia!", "Queijo derretido top!",
            "Simplesmente perfeito!", "Dez de dez!", "Eu voltarei!", "Fant√°stico!", "Sabor impec√°vel, mate!",
            "Muito bom, amigo!", "Que fatia de pizza!", "Obrigado, lenda!",
            "Entrega incrivelmente r√°pida! Voc√™ √© um foguete, Helber!",
            "Helber √© o mestre da velocidade! Ripper!",
            "Essa rapidez √© nota 10! N√£o deu tempo nem de piscar!",
            "√â sabor de S√£o Paulo, Helber! Que saudade da pizza brasileira!",
            "Esse queijo lembra o da Mooca! Sabor de casa!",
            "Atendimento Aussie, sabor brasileiro. Combina√ß√£o perfeita!",
        ];
        const HELBER_SPEAK = {
            START: "G'day, mate! Let's make some wicked pizzas today!",
            CORRECT: "Fair dinkum! Nailed it, mate! Get that dough!",
            WRONG: "Crikey! That's gone belly up. Try again, cobber!",
            NEXT_PHASE: "Ripper! We smashed that day. Now for the next one!",
            VICTORY: "You beaut! We did it! Pizza empire, here we come!",
        };
        let timerInterval = null;
        let comboStreak = 0;

        // --- DOM Elements ---
        const elements = {
            faseCounter: document.getElementById('fase-counter'),
            pizzaCounter: document.getElementById('pizza-counter'),
            saldoCounter: document.getElementById('saldo-counter'),
            highscoreDisplay: document.getElementById('highscore-display'),
            gameMessage: document.getElementById('game-message'),
            ingredientButtons: document.getElementById('ingredient-buttons'),
            recipeList: document.getElementById('recipe-list'),
            pizzaStack: document.getElementById('pizza-stack'),
            deliverBtn: document.getElementById('deliver-btn'),
            currentOrderName: document.getElementById('current-order-name'),
            customerAvatar: document.getElementById('customer-avatar'),
            feedbackText: document.getElementById('feedback-text'),
            timerBarFill: document.getElementById('timer-bar-fill'),
            
            gameModal: document.getElementById('game-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalActions: document.getElementById('modal-actions'),
            startGameBtn: document.getElementById('start-game-btn'),
            // NOVO: Refer√™ncia ao elemento de √°udio
            backgroundMusic: document.getElementById('background-music'), 
            currentPizzaBase: document.getElementById('current-pizza-base'),
            customerWaitTimer: document.getElementById('customer-wait-timer'),
        };

        // --- Firebase Setup (L√≥gica mantida para persist√™ncia) ---
        let db, auth;
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not available. Running game without persistence.");
                GAME_STATE.isAuthReady = true;
                elements.highscoreDisplay.textContent = "Recorde: R$ 0 (Local)";
                return;
            }

            try {
                // ... (L√≥gica de inicializa√ß√£o Firebase omitida para brevidade, mas mantida no c√≥digo original)
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Log level for Firestore

                let userCredential;
                try {
                    if (initialAuthToken) {
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        userCredential = await signInAnonymously(auth);
                    }
                } catch (error) {
                    userCredential = await signInAnonymously(auth);
                }

                GAME_STATE.userId = userCredential.user.uid;
                GAME_STATE.isAuthReady = true;
                loadGameState();
            } catch (error) {
                console.error("Erro fatal ao inicializar Firebase ou Autenticar:", error);
                GAME_STATE.isAuthReady = true;
                elements.highscoreDisplay.textContent = "Recorde: R$ 0 (Erro Auth)";
            }
        }

        function getUserScoreDocRef() {
            if (!db || !GAME_STATE.userId) return null;
            const collectionPath = `/artifacts/${appId}/users/${GAME_STATE.userId}/pizzagame_scores`;
            return doc(db, collectionPath, 'high_score');
        }

        function loadGameState() {
            if (!GAME_STATE.isAuthReady || !db || !GAME_STATE.userId) return;
            const docRef = getUserScoreDocRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    GAME_STATE.highScore = data.highScore || 0;
                } else {
                    saveGameState();
                }
                updateUI();
            }, (error) => {
                console.error("Erro ao ouvir High Score:", error);
            });
        }

        async function saveGameState() {
            if (!GAME_STATE.isAuthReady || !db || !GAME_STATE.userId) return;
            try {
                const docRef = getUserScoreDocRef();
                if (!docRef) return;
                await setDoc(docRef, {
                    highScore: GAME_STATE.highScore,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
            } catch (e) {
                console.error("Erro ao salvar High Score:", e);
            }
        }

        // --- Web Speech Synthesis (Helber's Voice) ---

        function helberSpeak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';

                const voices = window.speechSynthesis.getVoices();
                let aussieVoice = voices.find(voice => voice.lang === 'en-AU');
                if (aussieVoice) {
                    utterance.voice = aussieVoice;
                } else {
                    utterance.voice = voices[0] ||
                        null;
                }

                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("Speech Synthesis n√£o suportado neste navegador.");
            }
        }

        // --- Game Logic ---

        function startGame() {
            // NOVO: Toca a m√∫sica ao clique do usu√°rio
            elements.backgroundMusic.play().catch(error => {
                // Captura e ignora o erro se a reprodu√ß√£o falhar (ex: se o usu√°rio pausar manualmente e tentar dar play de novo)
                console.error("Falha ao tentar tocar a m√∫sica:", error);
            });
            
            GAME_STATE.currentPhase = 1;
            GAME_STATE.balance = 0;
            GAME_STATE.streak = 0;
            GAME_STATE.isGameRunning = true;
            hideModal();
            startPhase();
            helberSpeak(HELBER_SPEAK.START);
        }

        function startPhase() {
            const phase = PHASES[GAME_STATE.currentPhase];
            GAME_STATE.pizzasCompleted = 0;
            GAME_STATE.phaseGoal = phase.goal;
            GAME_STATE.timerMax = phase.timer * 1000;
            GAME_STATE.elapsedTime = 0; // Reset do tempo decorrido
            GAME_STATE.appliedIngredients = [];
            resetPizzaBench();
            updateUI();
            displayMessage(phase.message);
            // S√≥ gera o pedido se o timer for relevante, sen√£o espera o clique (Fase 1)
            if (GAME_STATE.currentPhase === 1) {
                // Fase 1 √© para aprender, sem press√£o de tempo.
                elements.customerWaitTimer.textContent = "CLIENTE AGUARDANDO A (PRONTO)";
                generateNextOrder();
            } else {
                GAME_STATE.currentOrder = null;
                // O primeiro clique de ingrediente gera o primeiro pedido e come√ßa o timer
                elements.currentOrderName.textContent = "Aguardando 1¬∫ Ingrediente...";
                elements.customerAvatar.textContent = "üë®‚Äçüç≥";
                elements.customerWaitTimer.textContent = "CLIENTE AGUARDANDO A (PRONTO)";
            }
            renderIngredientButtons();
            renderRecipeList();
        }

        /**
         * Retorna a lista de nomes de ingredientes que est√£o em *qualquer* receita
         * dispon√≠vel para a fase atual.
         */
        function getAvailableIngredientsForPhase() {
            const availableRecipes = Object.keys(RECIPES).filter(name => RECIPES[name].phaseMin <= GAME_STATE.currentPhase);
            const uniqueIngredients = new Set();

            availableRecipes.forEach(rName => {
                RECIPES[rName].ingredients.forEach(iName => {
                    uniqueIngredients.add(iName);
                });
            });
            // Na Fase 1, se tivermos uma lista restrita de receitas, usamos elas.
            if (GAME_STATE.currentPhase === 1) {
                const phase1Recipes = PHASES[1].available;
                // Nomes das receitas
                const phase1Ingredients = new Set();
                phase1Recipes.forEach(rName => {
                    if (RECIPES[rName]) {
                        RECIPES[rName].ingredients.forEach(iName => phase1Ingredients.add(iName));
                    }
                });
                return Array.from(phase1Ingredients);
            }

            return Array.from(uniqueIngredients);
        }

        // --- Fun√ß√£o para renderizar bot√µes de Ingredientes ---
        function renderIngredientButtons() {
            const availableIngredients = getAvailableIngredientsForPhase();
            elements.ingredientButtons.innerHTML = '';

            availableIngredients.forEach(name => {
                const ingredient = INGREDIENTS[name];
                const button = document.createElement('button');
                button.textContent = `${ingredient.emoji} ${name}`;
                button.className = `ingredient-btn bg-white text-gray-800 text-xs font-bold py-2 px-1 rounded-lg shadow-md hover:bg-fundo-claro border border-gray-300`;
                button.title = name;
                button.onclick = () => {
                    if (!GAME_STATE.currentOrder && GAME_STATE.currentPhase > 1) {
                        // Se n√£o h√° pedido e n√£o √© a Fase 1 (que gera na inicializa√ß√£o)
                        generateNextOrder();
                        startTimer();
                    }
                    addIngredient(name);
                };
                elements.ingredientButtons.appendChild(button);
            });
        }
        
        // --- Fun√ß√£o para renderizar a lista de receitas ---
        function renderRecipeList() {
            const availableRecipes = Object.keys(RECIPES).filter(name => RECIPES[name].phaseMin <= GAME_STATE.currentPhase);
            elements.recipeList.innerHTML = '';
            
            let recipesToDisplay = availableRecipes;
            if (GAME_STATE.currentPhase === 1) {
                recipesToDisplay = PHASES[1].available;
            } else if (PHASES[GAME_STATE.currentPhase].available) {
                // Se o n√∫mero estiver limitado, exibe a lista limitada
                const numAvailable = PHASES[GAME_STATE.currentPhase].available;
                recipesToDisplay = availableRecipes.slice(0, numAvailable);
            }

            recipesToDisplay.forEach(recipeName => {
                const recipe = RECIPES[recipeName];
                const ingredientEmojis = recipe.ingredients.map(iName => INGREDIENTS[iName].emoji).join(' > ');
                
                const recipeItem = document.createElement('p');
                recipeItem.className = 'bg-gray-100 p-2 rounded-md border-l-2 border-aussie-orange/50';
                recipeItem.innerHTML = `<strong>${recipeName}:</strong> <span class="text-sm">${ingredientEmojis}</span> (R$ ${recipe.price})`;
                elements.recipeList.appendChild(recipeItem);
            });
        }


        function generateNextOrder() {
            const allRecipes = Object.keys(RECIPES).filter(name => RECIPES[name].phaseMin <= GAME_STATE.currentPhase);
            let availableRecipes = allRecipes;

            if (GAME_STATE.currentPhase === 1) {
                availableRecipes = PHASES[1].available;
                // Usa a lista restrita de nomes de receita
            } else {
                // Se a fase tem um limite de receitas (o n√∫mero em 'available'), usa um subconjunto
                const numAvailable = PHASES[GAME_STATE.currentPhase].available;
                availableRecipes = allRecipes.slice(0, numAvailable);
            }

            const randomRecipeName = availableRecipes[Math.floor(Math.random() * availableRecipes.length)];
            const order = RECIPES[randomRecipeName];

            GAME_STATE.currentOrder = {
                name: randomRecipeName,
                recipe: order.ingredients,
                price: order.price,
            };
            elements.currentOrderName.textContent = GAME_STATE.currentOrder.name;
            elements.customerAvatar.textContent = getRandomCustomerEmoji();
            // O timer s√≥ come√ßa a contar quando o pedido √© gerado (exceto Fase 1)
            if (GAME_STATE.currentPhase > 1) {
                // Timer √© iniciado no primeiro clique de ingrediente
                elements.customerWaitTimer.textContent = "CLIENTE AGUARDANDO A (00:00)";
            }
            
            updateUI();
        }

        function addIngredient(ingredientName) {
            if (!GAME_STATE.isGameRunning || !GAME_STATE.currentOrder) return;
            GAME_STATE.appliedIngredients.push(ingredientName);
            renderPizzaStack();
            updateUI();
        }

        function deliverPizza() {
            if (GAME_STATE.appliedIngredients.length === 0 || !GAME_STATE.currentOrder) return;
            stopTimer();

            const correctRecipe = GAME_STATE.currentOrder.recipe;
            const applied = GAME_STATE.appliedIngredients;

            // 1. Verifica o tamanho
            if (applied.length !== correctRecipe.length) {
                handleWrongOrder("Falta ou sobra de ingredientes, Helber!");
                return;
            }

            // 2. Verifica a ordem exata
            let isCorrect = true;
            for (let i = 0; i < correctRecipe.length; i++) {
                if (applied[i] !== correctRecipe[i]) {
                    isCorrect = false;
                    break;
                }
            }

            if (isCorrect) {
                handleCorrectOrder();
            } else {
                handleWrongOrder("A ordem dos ingredientes est√° errada, cobber!");
            }
        }

        function handleCorrectOrder() {
            let price = GAME_STATE.currentOrder.price;
            comboStreak++;

            if (comboStreak >= 5) {
                price = Math.round(price * 1.5);
                elements.feedbackText.textContent = ` STREAK x1.5! Pizza perfeita! +R$${price}`;
                displayMessage(HELBER_SPEAK.CORRECT, 'text-green-700 font-extrabold');
            } else {
                const praise = getRandomPraisePhrase();
                elements.feedbackText.textContent = praise;
                displayMessage(HELBER_SPEAK.CORRECT, 'text-green-600');
            }

            // --- ALTERA√á√ÉO 3: L√≥gica do Combo Especial X2 na Fase 5 ---
            if (GAME_STATE.currentPhase === 5 && comboStreak > 0 && comboStreak % 3 === 0) {
                // Se na Fase 5, e a cada 3 acertos em sequ√™ncia, dobra o pre√ßo
                const extraEarnings = price;
                price *= 2;
                elements.feedbackText.textContent = ` COMBO ESPECIAL X2! +R$${extraEarnings} de B√îNUS! | ${elements.feedbackText.textContent}`;
            }
            // -----------------------------------------------------------
            
            GAME_STATE.balance += price;
            GAME_STATE.pizzasCompleted++;

            helberSpeak(HELBER_SPEAK.CORRECT);
            animatePizzaDelivery();

            setTimeout(() => {
                continueGameFlow();
            }, 1500);
        }

        function handleWrongOrder(reason) {
            GAME_STATE.balance = Math.max(0, GAME_STATE.balance - 20);
            comboStreak = 0;
            elements.feedbackText.textContent = ` Penalidade (-R$20). ${reason}`;
            displayMessage(` Crikey! That's gone belly up. Try again, cobber!`, 'text-red-600');
            helberSpeak(HELBER_SPEAK.WRONG);
            animatePizzaExplosion();

            setTimeout(() => {
                continueGameFlow();
            }, 1500);
        }

        function continueGameFlow() {
            if (GAME_STATE.pizzasCompleted >= GAME_STATE.phaseGoal) {
                stopTimer();
                if (GAME_STATE.currentPhase < 5) {
                    // Atualiza High Score antes de passar de fase
                    if (GAME_STATE.balance > GAME_STATE.highScore) {
                        GAME_STATE.highScore = GAME_STATE.balance;
                        saveGameState();
                    }

                    GAME_STATE.currentPhase++;
                    startPhase();
                    showModal(`Fim do Dia ${GAME_STATE.currentPhase - 1}`, `R$ ${GAME_STATE.balance} ganhos hoje! Prepare-se para o Dia ${GAME_STATE.currentPhase}.`, 'nextPhase');
                } else {
                    endGame(true);
                }
            } else {
                resetPizzaBench();
                updateUI();
                generateNextOrder();
            }
        }

        function endGame(isVictory) {
            GAME_STATE.isGameRunning = false;
            stopTimer();

            // Atualiza High Score no final do jogo
            if (GAME_STATE.balance > GAME_STATE.highScore) {
                GAME_STATE.highScore = GAME_STATE.balance;
                saveGameState();
            }
            
            // NOVO: Pausa a m√∫sica
            elements.backgroundMusic.pause();

            if (isVictory) {
                animateFireworks();
                showModal("Vit√≥ria! Lenda da Pizza!", `Voc√™ √© o Pizzaiolo n¬∫ 1 da Austr√°lia, Helber! Saldo Final: R$ ${GAME_STATE.balance}`, 'victory');
                helberSpeak(HELBER_SPEAK.VICTORY);
            } else {
                showModal("Game Over", `Voc√™ n√£o aguentou a press√£o! Saldo Final: R$ ${GAME_STATE.balance}`, 'gameOver');
                helberSpeak("Ah, well, that's disappointing mate. Have another go!");
            }
        }

        function resetPizzaBench() {
            GAME_STATE.appliedIngredients = [];
            elements.pizzaStack.innerHTML = '';
            // Restaura o texto base na bancada
            elements.currentPizzaBase.style.display = 'block';
            elements.deliverBtn.disabled = true;
        }

        // --- Timer Logic (Alterado para contar o tempo decorrido) ---

        function startTimer() {
            // Se Fase 1, n√£o precisa de timer
            if (GAME_STATE.currentPhase === 1 || GAME_STATE.timerMax <= 0) {
                elements.timerBarFill.style.width = '100%';
                elements.customerWaitTimer.textContent = "CLIENTE AGUARDANDO A (PRONTO)";
                return;
            }
            
            // Limpa qualquer timer anterior
            stopTimer();
            GAME_STATE.elapsedTime = 0; // Come√ßa a contagem do zero
            
            timerInterval = setInterval(() => {
                GAME_STATE.elapsedTime += 100; // Aumenta 100ms
                const timeLeft = GAME_STATE.timerMax - GAME_STATE.elapsedTime;
                
                // Calcula a porcentagem com base no tempo RESTANTE para a barra decrescer
                let percentage = (timeLeft / GAME_STATE.timerMax) * 100; 

                // Atualiza a barra
                elements.timerBarFill.style.width = `${percentage}%`;
                
                // Mudar a cor da barra dependendo do tempo
                if (percentage > 50) {
                    elements.timerBarFill.className = 'bg-green-500 h-4 rounded-full';
                    elements.customerWaitTimer.className = 'text-md font-bold text-green-600 mb-2';
                } else if (percentage > 20) {
                    elements.timerBarFill.className = 'bg-yellow-500 h-4 rounded-full';
                    elements.customerWaitTimer.className = 'text-md font-bold text-yellow-600 mb-2';
                } else {
                    elements.timerBarFill.className = 'bg-red-500 h-4 rounded-full';
                    elements.customerWaitTimer.className = 'text-md font-bold text-red-600 mb-2';
                }

                // Atualiza o texto do timer com o tempo restante
                const seconds = Math.floor(timeLeft / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                const timeString = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                elements.customerWaitTimer.textContent = `CLIENTE AGUARDANDO A (${timeString})`;
                
                if (timeLeft <= 0) {
                    handleTimeOut();
                }
            }, 100);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        function resetTimer(maxTime) {
             stopTimer();
             // Inicia o timer novamente se for uma fase com tempo limite
             if (GAME_STATE.currentPhase > 1 && maxTime > 0) {
                 startTimer();
             } else {
                 elements.timerBarFill.style.width = '100%';
                 elements.timerBarFill.className = 'bg-green-500 h-4 rounded-full';
             }
        }


        function handleTimeOut() {
            stopTimer();
            if (GAME_STATE.currentOrder) {
                elements.feedbackText.textContent = ` CLIENTE FUGIU! O tempo acabou!`;
                displayMessage("Too slow, mate! We lost that one!", 'text-red-700 font-extrabold');
                endGame(false); // Game Over por tempo esgotado
            }
        }

        // --- UI Rendering ---

        function updateUI() {
            const currentPhase = PHASES[GAME_STATE.currentPhase];
            elements.faseCounter.textContent = `Fase: ${GAME_STATE.currentPhase}/5`;
            elements.pizzaCounter.textContent = `Pizzas: ${GAME_STATE.pizzasCompleted}/${currentPhase.goal}`;
            elements.saldoCounter.textContent = `Saldo: R$ ${GAME_STATE.balance}`;
            elements.highscoreDisplay.textContent = `Recorde: R$ ${GAME_STATE.highScore}`;
            
            elements.helberAvatar.textContent = (comboStreak >= 5) ? 'ü•á' : 'üßë‚Äçüç≥';
            
            // Bot√£o Entregar
            if (GAME_STATE.currentOrder && GAME_STATE.appliedIngredients.length > 0) {
                elements.deliverBtn.disabled = false;
                elements.deliverBtn.className = 'w-full max-w-sm bg-aussie-green text-white font-black text-xl py-3 rounded-full shadow-lg transition duration-150 hover:bg-aussie-orange';
            } else {
                elements.deliverBtn.disabled = true;
                elements.deliverBtn.className = 'w-full max-w-sm bg-gray-400 text-white font-black text-xl py-3 rounded-full shadow-lg transition duration-150 hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed';
            }
        }

        function renderPizzaStack() {
            elements.pizzaStack.innerHTML = '';
            elements.currentPizzaBase.style.display = 'none'; // Esconde o texto base

            GAME_STATE.appliedIngredients.forEach((ingredientName, index) => {
                const ingredient = INGREDIENTS[ingredientName];
                const layerDiv = document.createElement('div');
                layerDiv.className = `pizza-layer ${ingredient.type}`;
                // Tenta dar um efeito 3D
                layerDiv.style.width = `${60 + (index * 5)}%`; // Largura crescente
                
                const emoji = document.createElement('span');
                emoji.textContent = ingredient.emoji;
                emoji.className = 'text-lg absolute';
                layerDiv.appendChild(emoji);

                elements.pizzaStack.appendChild(layerDiv);
            });
        }
        
        function displayMessage(text, className = 'text-gray-800') {
            elements.gameMessage.innerHTML = `Helber: "${text}"`;
            elements.gameMessage.className = `mt-3 text-center text-xl font-semibold ${className}`;
        }

        // --- Modal/FX ---

        function showModal(title, body, type) {
            elements.modalTitle.textContent = title;
            elements.modalBody.textContent = body;
            elements.modalActions.innerHTML = ''; // Limpa bot√µes anteriores
            
            if (type === 'nextPhase') {
                const nextBtn = document.createElement('button');
                nextBtn.id = 'continue-game-btn';
                nextBtn.className = 'bg-aussie-orange text-white font-bold py-3 px-6 rounded-full text-lg transition duration-150 hover:bg-aussie-green';
                nextBtn.textContent = `Iniciar Dia ${GAME_STATE.currentPhase}`;
                nextBtn.onclick = hideModal;
                elements.modalActions.appendChild(nextBtn);
            } else if (type === 'gameOver' || type === 'victory') {
                const restartBtn = document.createElement('button');
                restartBtn.id = 'restart-game-btn';
                restartBtn.className = 'bg-aussie-green text-white font-bold py-3 px-6 rounded-full text-lg transition duration-150 hover:bg-aussie-orange';
                restartBtn.textContent = 'Jogar Novamente';
                restartBtn.onclick = () => {
                    hideModal();
                    // Reinicia o estado do jogo para a fase inicial
                    GAME_STATE.currentPhase = 1; 
                    GAME_STATE.balance = 0;
                    GAME_STATE.pizzasCompleted = 0;
                    startGame();
                };
                elements.modalActions.appendChild(restartBtn);
            } else {
                 const startBtn = document.createElement('button');
                 startBtn.id = 'start-game-btn';
                 startBtn.className = 'bg-aussie-orange text-white font-bold py-3 px-6 rounded-full text-lg transition duration-150 hover:bg-aussie-green';
                 startBtn.textContent = 'Iniciar Dia 1';
                 startBtn.onclick = startGame;
                 elements.modalActions.appendChild(startBtn);
            }
            
            elements.gameModal.classList.remove('hidden');
        }

        function hideModal() {
            elements.gameModal.classList.add('hidden');
            if (GAME_STATE.isGameRunning) {
                // Se o jogo estiver rodando (e n√£o foi Game Over), continua a fase.
                if (GAME_STATE.currentOrder) {
                    resetTimer(GAME_STATE.timerMax);
                } else if (GAME_STATE.currentPhase > 1) {
                    // Se for uma nova fase (Dia 2+), o jogo espera o primeiro clique para come√ßar o timer.
                    elements.currentOrderName.textContent = "Aguardando 1¬∫ Ingrediente...";
                    elements.customerAvatar.textContent = "üë®‚Äçüç≥";
                    elements.customerWaitTimer.textContent = "CLIENTE AGUARDANDO A (PRONTO)";
                }
            }
        }
        
        function animatePizzaDelivery() {
            // L√≥gica para animar a pizza (ex: desaparecer ou mover para fora da tela)
            const stack = elements.pizzaStack;
            stack.style.transition = 'transform 0.5s ease-in, opacity 0.5s ease-in';
            stack.style.transform = 'translateY(-100px) translateX(300px) rotate(45deg)';
            stack.style.opacity = '0';
            
            setTimeout(() => {
                stack.style.transition = 'none';
                stack.style.transform = 'none';
                stack.style.opacity = '1';
                resetPizzaBench(); // Limpa e prepara para o pr√≥ximo
            }, 500);
        }
        
        function animatePizzaExplosion() {
            // Simula uma "explos√£o" de pizza/ingredientes
            const stack = elements.pizzaStack;
            const pieces = [];
            for (let i = 0; i < 10; i++) {
                const piece = document.createElement('div');
                piece.className = 'pizza-layer layer-molho absolute'; // Camada vermelha/ingrediente
                piece.style.width = '10px';
                piece.style.height = '10px';
                piece.style.borderRadius = '50%';
                piece.style.backgroundColor = (i % 2 === 0) ? '#c0392b' : '#f1c40f'; // Vermelho/Amarelo
                
                const x = Math.random() * 300 - 150; // -150 a 150
                const y = Math.random() * 300 - 150; // -150 a 150
                
                piece.style.setProperty('--x', `${x}px`);
                piece.style.setProperty('--y', `${y}px`);
                piece.classList.add('firework');
                pieces.push(piece);
                stack.appendChild(piece);
            }
            
            stack.style.opacity = '0'; // Esconde a pilha
            
            setTimeout(() => {
                pieces.forEach(p => p.remove());
                stack.style.opacity = '1';
                resetPizzaBench(); // Limpa e prepara para o pr√≥ximo
            }, 800);
        }

        function animateFireworks() {
            const container = document.getElementById('game-ui');
            const colors = ['red', 'yellow', 'green', 'orange', 'purple'];

            for (let i = 0; i < 20; i++) {
                const firework = document.createElement('div');
                firework.classList.add('firework');
                firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                // Posi√ß√£o inicial aleat√≥ria (centro da tela modal)
                const startX = (container.offsetWidth / 2) + (Math.random() * 20 - 10);
                const startY = (container.offsetHeight / 2) + (Math.random() * 20 - 10);
                firework.style.left = `${startX}px`;
                firework.style.top = `${startY}px`;

                // Posi√ß√£o final (expans√£o)
                const endX = Math.random() * 600 - 300;
                const endY = Math.random() * 600 - 300;
                firework.style.setProperty('--x', `${endX}px`);
                firework.style.setProperty('--y', `${endY}px`);

                container.appendChild(firework);
                
                setTimeout(() => firework.remove(), 1000);
            }
        }
        

        function getRandomCustomerEmoji() {
            const emojis = ['üßë', 'üë©', 'üë¥', 'üëµ', 'üë®‚Äçüé§', 'üßë‚ÄçüöÄ', 'üë∑', 'üëÆ', 'üë®‚Äçüíª', 'üë©‚Äçüè´', 'üë®‚Äçüåæ', 'üë©‚Äçüç≥', 'üßë‚Äçüéì', 'ü¶ò'];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function getRandomPraisePhrase() {
            return PRAISE_PHRASES[Math.floor(Math.random() * PRAISE_PHRASES.length)];
        }

        // --- Event Listeners ---
        elements.deliverBtn.addEventListener('click', deliverPizza);
        elements.startGameBtn.addEventListener('click', startGame);

        // --- Initial Call ---
        initFirebase();
        // Garante que o modal inicial √© mostrado at√© a autentica√ß√£o estar pronta ou falhar
        setTimeout(() => {
            if (!GAME_STATE.isGameRunning) {
                showModal("Bem-vindo, Mate!", "Pressione Iniciar para come√ßar sua jornada como o Pizzaiolo Helber B! (√â altamente recomendado iniciar o jogo com um clique do mouse ou toque na tela para permitir a reprodu√ß√£o de √°udio e fala do Helber.)", 'initial');
            }
        }, 100);
        
        // NOVO: Adiciona o Helber Avatar (Aussie Man)
        document.getElementById('helber-avatar').textContent = 'ü§†';

    </script>
</body>
</html>
